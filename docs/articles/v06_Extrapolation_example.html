<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>flexsdm: Tools to explore extrapolation in SDMs • flexsdm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="flexsdm: Tools to explore extrapolation in SDMs">
<meta name="google-site-verification" content="gcou8tqRTwNjZ_Mf1kbFgAzzUcY3OF-JB2sPRPTA56I">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">flexsdm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html" aria-label="Home"><span class="fa fa-home"></span> Home</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v01_pre_modeling.html">1. Overview of Pre-modeling functions</a></li>
    <li><a class="dropdown-item" href="../articles/v02_modeling.html">2. Overview of Modeling functions</a></li>
    <li><a class="dropdown-item" href="../articles/v03_post_modeling.html">3. Overview of Post-modeling functions</a></li>
    <li><a class="dropdown-item" href="../articles/v04_Red_fir_example.html">4. An example with Red Fir</a></li>
    <li><a class="dropdown-item" href="../articles/v05_Rare_species_example.html">5. Modeling a rare species</a></li>
    <li><a class="dropdown-item" href="../articles/v06_Extrapolation_example.html">6. Tools to explore extrapolation in SDMs</a></li>
    <li><a class="dropdown-item" href="../articles/v07_Complete_workflow.html">7. Modeling workflow for several species</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/pkg_citation.html">Citations</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/pkg_citation.html">Citations</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html"><span class="fa fa-newspaper-o"></span> News</a></li>
<li class="nav-item"><a class="nav-link" href="https://sjevelazco.github.io/flexsdm" aria-label="GitHub">GitHub</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/sjevelazco/flexsdm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>flexsdm: Tools to explore extrapolation in SDMs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/sjevelazco/flexsdm/blob/HEAD/vignettes/v06_Extrapolation_example.Rmd" class="external-link"><code>vignettes/v06_Extrapolation_example.Rmd</code></a></small>
      <div class="d-none name"><code>v06_Extrapolation_example.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Many SDM applications require model extrapolation, e.g., predictions
beyond the range of the data set used to fit the model. For example,
models often must extrapolate when predicting habitat suitability under
novel environmental conditions induced by climate change or predicting
the spread of an invasive species outside of its native range based on
the species-environment relationship observed in its native range.</p>
<p>In <em>flexsdm</em>, we offer a new approach (known as <a href="https://onlinelibrary.wiley.com/doi/full/10.1111/ecog.06992" class="external-link"><strong>Shape</strong></a>)
for evaluating the extrapolation and truncating spatial predictions
based on the degree of extrapolation measured. Shape is a model-agnostic
approach for calculating the degree of extrapolation for a given
projection data point by its multivariate distance to the nearest
training data point – capturing the often complex shape of data within
environmental space. These distances are then relativized by a factor
that reflects the dispersion of the training data in environmental
space. As implemented in <em>flexsdm</em>, the Shape approach also
incorporates an adjustable threshold to allow for binary discrimination
between acceptable and unacceptable degrees of extrapolation, based on
the user’s needs and applications. For more information about Shape
metric, we recommend reading the article <a href="https://onlinelibrary.wiley.com/doi/full/10.1111/ecog.06992" class="external-link">Velazco
et al., 2023</a>.</p>
<p>In this vignette, we will walk through how to evaluate model
extrapolation for <em>Hesperocyparis stephensonii</em> (Cuyamaca
cypress), a conifer tree species that is endemic to southern California.
This species is listed as Critically Endangered by the IUCN and has an
extremely restricted distribution, as it is only found in the headwaters
of King Creek in San Diego County.</p>
<p>Note: this tutorial follows generally the same workflow as the
vignette for modeling the distribution of a rare species using an
ensemble of small models (ESM). However, instead of constructing ESMs,
we will evaluate model extrapolation if we were to predict our models to
the extent of the California Floristic Province (CFP).</p>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>For our models, we will use four environmental variables that
influence plant distributions in California: available
evapotranspiration (aet), climatic water deficit (cwd), maximum
temperature of the warmest month (tmx), and minimum temperature of the
coldest month (tmn). Our occurrence data include 21 geo-referenced
observations downloaded from the online database Calflora.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sjevelazco.github.io/flexsdm">flexsdm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># environmental data</span></span>
<span><span class="va">somevar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"external/somevar.tif"</span>, package <span class="op">=</span> <span class="st">"flexsdm"</span><span class="op">)</span></span>
<span><span class="va">somevar</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">somevar</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">somevar</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cwd"</span>, <span class="st">"tmn"</span>, <span class="st">"aet"</span>, <span class="st">"ppt_jja"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># species occurence data (presence-only)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">hespero</span><span class="op">)</span></span>
<span><span class="va">hespero</span> <span class="op">&lt;-</span> <span class="va">hespero</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">id</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># California ecoregions</span></span>
<span><span class="va">regions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"external/regions.tif"</span>, package <span class="op">=</span> <span class="st">"flexsdm"</span><span class="op">)</span></span>
<span><span class="va">regions</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">regions</span><span class="op">)</span></span>
<span><span class="va">regions</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.polygons.html" class="external-link">as.polygons</a></span><span class="op">(</span><span class="va">regions</span><span class="op">)</span></span>
<span><span class="va">sp_region</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">regions</span>, <span class="va">regions</span><span class="op">$</span><span class="va">category</span> <span class="op">==</span> <span class="st">"SCR"</span><span class="op">)</span> <span class="co"># ecoregion where *Hesperocyparis stephensonii* is found</span></span>
<span></span>
<span><span class="co"># visualize the species occurrences</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">sp_region</span>,</span>
<span>  col <span class="op">=</span> <span class="st">"gray80"</span>,</span>
<span>  legend <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  axes <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Hesperocyparis stephensonii occurrences"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">hespero</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"black"</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span>
<span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"gray80"</span>, <span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">cols</span><span class="op">[</span><span class="va">regions</span><span class="op">$</span><span class="va">category</span> <span class="op">==</span> <span class="st">"SCR"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"yellow"</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/inset.html" class="external-link">inset</a></span><span class="op">(</span></span>
<span>  <span class="va">regions</span>,</span>
<span>  loc <span class="op">=</span> <span class="st">"bottomleft"</span>,</span>
<span>  scale <span class="op">=</span> <span class="fl">.3</span>,</span>
<span>  col <span class="op">=</span> <span class="va">cols</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/raw%20data-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="delimit-calibration-area">Delimit calibration area<a class="anchor" aria-label="anchor" href="#delimit-calibration-area"></a>
</h2>
<p>First, we must define our model’s calibration area. The
<em>flexsdm</em> package offers several methods for defining the model
calibration area. Here, we will use 25-km buffer areas around the
presence points to select our pseudo-absence locations.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ca</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_area.html">calib_area</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">hespero</span>,</span>
<span>  x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>  y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"buffer"</span>, width <span class="op">=</span> <span class="fl">25000</span><span class="op">)</span>,</span>
<span>  crs <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">somevar</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># visualize the species occurrences &amp; calibration area</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">sp_region</span>,</span>
<span>  col <span class="op">=</span> <span class="st">"gray80"</span>,</span>
<span>  legend <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  axes <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Calibration area and occurrences"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ca</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">hespero</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"black"</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/calibration%20area-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="create-pseudo-absence-data">Create pseudo-absence data<a class="anchor" aria-label="anchor" href="#create-pseudo-absence-data"></a>
</h2>
<p>As is often the case with rare species, we only have species presence
data. However, most SDM methods require either pseudo-absence or
background point data. Here, we use our calibration area to produce
pseudo-absence data that can be used in our SDMs.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sample the same number of species presences</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">psa</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_pseudoabs.html">sample_pseudoabs</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">hespero</span>,</span>
<span>  x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>  y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>  n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">hespero</span><span class="op">$</span><span class="va">pr_ab</span><span class="op">)</span>, <span class="co"># number of pseudo-absence points equal to number of presences</span></span>
<span>  method <span class="op">=</span> <span class="st">"random"</span>,</span>
<span>  rlayer <span class="op">=</span> <span class="va">somevar</span>,</span>
<span>  calibarea <span class="op">=</span> <span class="va">ca</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize species presences and pseudo-absences</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">sp_region</span>,</span>
<span>  col <span class="op">=</span> <span class="st">"gray80"</span>,</span>
<span>  legend <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  axes <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">289347</span>, <span class="fl">353284</span><span class="op">)</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">598052</span>, <span class="op">-</span><span class="fl">520709</span><span class="op">)</span>,</span>
<span>  main <span class="op">=</span> <span class="st">"Presence = yellow, Pseudo-absence = black"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ca</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">psa</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span>, cex <span class="op">=</span> <span class="fl">0.8</span>, pch <span class="op">=</span> <span class="fl">16</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="co"># Pseudo-absences</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">hespero</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"yellow"</span>, pch <span class="op">=</span> <span class="fl">16</span>, cex <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="co"># Presences</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/pseudo-absence%20data-1.png" width="672"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co"># Bind a presences and pseudo-absences</span></span>
<span><span class="va">hespero_pa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">hespero</span>, <span class="va">psa</span><span class="op">)</span></span>
<span><span class="va">hespero_pa</span> <span class="co"># Presence-Pseudo-absence database</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 42 × 3</span></span></span>
<span><span class="co">#&gt;          x        y pr_ab</span></span>
<span><span class="co">#&gt;      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> <span style="text-decoration: underline;">316</span>923. -<span style="color: #BB0000; text-decoration: underline;">557</span><span style="color: #BB0000;">843.</span>     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> <span style="text-decoration: underline;">317</span>155. -<span style="color: #BB0000; text-decoration: underline;">559</span><span style="color: #BB0000;">234.</span>     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> <span style="text-decoration: underline;">316</span>960. -<span style="color: #BB0000; text-decoration: underline;">558</span><span style="color: #BB0000;">186.</span>     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> <span style="text-decoration: underline;">314</span>347. -<span style="color: #BB0000; text-decoration: underline;">559</span><span style="color: #BB0000;">648.</span>     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> <span style="text-decoration: underline;">317</span>348. -<span style="color: #BB0000; text-decoration: underline;">557</span><span style="color: #BB0000;">349.</span>     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> <span style="text-decoration: underline;">316</span>753. -<span style="color: #BB0000; text-decoration: underline;">559</span><span style="color: #BB0000;">679.</span>     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> <span style="text-decoration: underline;">316</span>777. -<span style="color: #BB0000; text-decoration: underline;">558</span><span style="color: #BB0000;">644.</span>     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> <span style="text-decoration: underline;">317</span>050. -<span style="color: #BB0000; text-decoration: underline;">559</span><span style="color: #BB0000;">043.</span>     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> <span style="text-decoration: underline;">316</span>655. -<span style="color: #BB0000; text-decoration: underline;">559</span><span style="color: #BB0000;">928.</span>     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> <span style="text-decoration: underline;">316</span>418. -<span style="color: #BB0000; text-decoration: underline;">567</span><span style="color: #BB0000;">439.</span>     1</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 32 more rows</span></span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="partition-data-for-evaluating-models">Partition data for evaluating models<a class="anchor" aria-label="anchor" href="#partition-data-for-evaluating-models"></a>
</h2>
<p>To evaluate model performance, we need to specify data for testing
and training. <em>flexsdm</em> offers a range of random and spatial and
random data partition methods for evaluating SDMs. Here we will use
repeated K-fold cross-validation, which is a suitable partition approach
for validating SDM with few data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Repeated K-fold method</span></span>
<span><span class="va">hespero_pa2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/part_random.html">part_random</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">hespero_pa</span>,</span>
<span>  pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"rep_kfold"</span>, folds <span class="op">=</span> <span class="fl">5</span>, replicates <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="extracting-environmental-values">Extracting environmental values<a class="anchor" aria-label="anchor" href="#extracting-environmental-values"></a>
</h2>
<p>Next, we extract the values of our four environmental predictors at
the presence and pseudo-absence locations.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hespero_pa3</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/sdm_extract.html">sdm_extract</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">hespero_pa2</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    env_layer <span class="op">=</span> <span class="va">somevar</span>,</span>
<span>    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cwd"</span>, <span class="st">"tmn"</span>, <span class="st">"aet"</span>, <span class="st">"ppt_jja"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="modeling">Modeling<a class="anchor" aria-label="anchor" href="#modeling"></a>
</h2>
<p>Let’s use three standard algorithms to model the distribution of
<em>Hesperocyparis stephensonii</em>: GLM, GBM, and SVM. In this case,
we will use the extent of the CFP as our prediction area so that we can
evaluate model extrapolation across a broad geographic area.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mglm</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/fit_glm.html">fit_glm</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">hespero_pa3</span>,</span>
<span>    response <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>    predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cwd"</span>, <span class="st">"tmn"</span>, <span class="st">"aet"</span>, <span class="st">"ppt_jja"</span><span class="op">)</span>,</span>
<span>    partition <span class="op">=</span> <span class="st">".part"</span>,</span>
<span>    thr <span class="op">=</span> <span class="st">"max_sens_spec"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">mgbm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_gbm.html">fit_gbm</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">hespero_pa3</span>,</span>
<span>  response <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cwd"</span>, <span class="st">"tmn"</span>, <span class="st">"aet"</span>, <span class="st">"ppt_jja"</span><span class="op">)</span>,</span>
<span>  partition <span class="op">=</span> <span class="st">".part"</span>,</span>
<span>  thr <span class="op">=</span> <span class="st">"max_sens_spec"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">msvm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_svm.html">fit_svm</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">hespero_pa3</span>,</span>
<span>  response <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cwd"</span>, <span class="st">"tmn"</span>, <span class="st">"aet"</span>, <span class="st">"ppt_jja"</span><span class="op">)</span>,</span>
<span>  partition <span class="op">=</span> <span class="st">".part"</span>,</span>
<span>  thr <span class="op">=</span> <span class="st">"max_sens_spec"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">mpred</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdm_predict.html">sdm_predict</a></span><span class="op">(</span></span>
<span>  models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">mglm</span>, <span class="va">mgbm</span>, <span class="va">msvm</span><span class="op">)</span>,</span>
<span>  pred <span class="op">=</span> <span class="va">somevar</span>,</span>
<span>  con_thr <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  predict_area <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="comparing-our-models">Comparing our models<a class="anchor" aria-label="anchor" href="#comparing-our-models"></a>
</h2>
<p>First, let’s take a look at the spatial predictions for our models.
GLM and GBM predict a lot of suitable habitat very far from where the
species is found!</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mpred</span><span class="op">$</span><span class="va">glm</span>, main <span class="op">=</span> <span class="st">"GLM"</span><span class="op">)</span></span>
<span><span class="co"># points(hespero$x, hespero$y, pch = 19)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mpred</span><span class="op">$</span><span class="va">gbm</span>, main <span class="op">=</span> <span class="st">"GBM"</span><span class="op">)</span></span>
<span><span class="co"># points(hespero$x, hespero$y, pch = 19)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mpred</span><span class="op">$</span><span class="va">svm</span>, main <span class="op">=</span> <span class="st">"SVM"</span><span class="op">)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/comparison%20maps-1.png" width="672"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># points(hespero$x, hespero$y, pch = 19)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="partial-dependence-plots-to-explore-the-impact-of-predictor-conditions-on-suitability">Partial dependence plots to explore the impact of predictor
conditions on suitability<a class="anchor" aria-label="anchor" href="#partial-dependence-plots-to-explore-the-impact-of-predictor-conditions-on-suitability"></a>
</h2>
<p>Extrapolation reflects an issue with how a model handles novel data.
Here, we see that the three algorithms explored in this tutorial predict
pretty different geographic patterns of habitat suitability based on the
same occurrence/pseudo-absence data and environmental predictors. Let’s
take a look at some partial dependence plots to see that the marginal
effect of each of the environmental predictors on suitability looks like
for each of our test models. This function allows you to visualize the
how a model may extrapolate outside the environmental conditions used in
training, by visualizing the “projection” data in a different color. In
this case, that will be our environmental predictors that cover the
extent of the CFP. <em>flexsdm</em> allows users to plot univariate
partial dependence plots (<a href="https://sjevelazco.github.io/flexsdm/reference/p_pdp.html"><code>p_pdp</code></a>)
and bivariate partial dependence plots (<a href="https://sjevelazco.github.io/flexsdm/reference/p_bpdp.html"><code>p_bpdp</code></a>);
both are shown below for each model. Note: the p_bpdp function allows
users the option to show the boundaries for the training data using
either a rectangle or convex hull approach. Here we will use the convex
hull approach.</p>
<p>Uni and bivariate partial dependence plots for the GLM:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/p_pdp.html">p_pdp</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">mglm</span><span class="op">$</span><span class="va">model</span>, training_data <span class="op">=</span> <span class="va">hespero_pa3</span>, projection_data <span class="op">=</span> <span class="va">somevar</span><span class="op">)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/glm%20partial%20dependence%20plots-1.png" width="672"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/p_bpdp.html">p_bpdp</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">mglm</span><span class="op">$</span><span class="va">model</span>, training_data <span class="op">=</span> <span class="va">hespero_pa3</span>, training_boundaries <span class="op">=</span> <span class="st">"convexh"</span><span class="op">)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/glm%20partial%20dependence%20plots-2.png" width="672"></p>
<p>Uni and bivariate partial dependence plots for the GBM:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/p_pdp.html">p_pdp</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">mgbm</span><span class="op">$</span><span class="va">model</span>, training_data <span class="op">=</span> <span class="va">hespero_pa3</span>, projection_data <span class="op">=</span> <span class="va">somevar</span><span class="op">)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/gbm%20partial%20dependence%20plots-1.png" width="672"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/p_bpdp.html">p_bpdp</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">mgbm</span><span class="op">$</span><span class="va">model</span>, training_data <span class="op">=</span> <span class="va">hespero_pa3</span>, training_boundaries <span class="op">=</span> <span class="st">"convexh"</span>, resolution <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/gbm%20partial%20dependence%20plots-2.png" width="672"></p>
<p>Uni and bivariate partial dependence plots for the SVM:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/p_pdp.html">p_pdp</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">msvm</span><span class="op">$</span><span class="va">model</span>, training_data <span class="op">=</span> <span class="va">hespero_pa3</span>, projection_data <span class="op">=</span> <span class="va">somevar</span><span class="op">)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/svm%20partial%20dependence%20plots-1.png" width="672"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/p_bpdp.html">p_bpdp</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">msvm</span><span class="op">$</span><span class="va">model</span>, training_data <span class="op">=</span> <span class="va">hespero_pa3</span>, training_boundaries <span class="op">=</span> <span class="st">"convexh"</span><span class="op">)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/svm%20partial%20dependence%20plots-2.png" width="672"></p>
<p>These plots show a really interesting story! Most notably, the GLM
and GBM show consistently high habitat suitability for those areas that
have much higher actual evapotranspiration than the very narrow range of
values that were used to train the model. However, the SVM seems to do
the best job of not estimating very high habitat suitability for
environmental values that were outside of the training data.
Importantly, these models can behave very differently depending on the
modeling situation and context.</p>
</div>
<div class="section level2">
<h2 id="extrapolation-evaluation">Extrapolation evaluation<a class="anchor" aria-label="anchor" href="#extrapolation-evaluation"></a>
</h2>
<p>Remember that our species is highly restricted to southern
California! However, two of our models (GLM and GBM) predict very high
habitat suitability throughout other parts of the CFP, while the SVM
provides more conservative predictions. We see that GLM and GBM tend to
predict high habitat suitability in those areas that are very
environmentally different from our training conditions. But where are
our models extrapolating in environmental space? Let’s find out using
the “extra_eval” function in SDM. This function requires you to input
the model training data, a column specifying presence vs. absence
locations, projection data (can be a SpatRaster or a tibble containing
data used for model projection – this can reflect a larger region,
separate region, or different time period than what was used for model
training), a metric for calculating the degree of extrapolation (the
default is Mahalanobis distance, though euclidean is also an option- we
will explore both), number of cores for parallel processing, and an
aggregation factor, in case you want to measure extrapolation for a very
large data set.</p>
<p>First we look at the degree of extrapolation in geographic space
using the Shape method based on Mahalanobis distance. Also we will
distinguish between univariate and combinatorial extrapolation.</p>
<p>Using Mahalanobis distance:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xp_m</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/extra_eval.html">extra_eval</a></span><span class="op">(</span></span>
<span>    training_data <span class="op">=</span> <span class="va">hespero_pa3</span>,</span>
<span>    pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>    projection_data <span class="op">=</span> <span class="va">somevar</span>,</span>
<span>    metric <span class="op">=</span> <span class="st">"mahalanobis"</span>,</span>
<span>    univar_comb <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    n_cores <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    aggreg_factor <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">xp_m</span></span>
<span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; size        : 558, 394, 2  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 1890, 1890  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -373685.8, 370974.2, -604813.3, 449806.7  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : +proj=aea +lat_0=0 +lon_0=-120 +lat_1=34 +lat_2=40.5 +x_0=0 +y_0=-4000000 +datum=NAD83 +units=m +no_defs </span></span>
<span><span class="co">#&gt; source(s)   : memory</span></span>
<span><span class="co">#&gt; names       : extrapolation, uni_comb </span></span>
<span><span class="co">#&gt; min values  :         0.000,        1 </span></span>
<span><span class="co">#&gt; max values  :      3730.677,        2</span></span></code></pre></div>
<p>The output of the extra_eval function is a SpatRaster, showing the
degree of extrapolation across the projection area, as estimated by the
Shape method.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#FDE725"</span>, <span class="st">"#B3DC2B"</span>, <span class="st">"#6DCC57"</span>, <span class="st">"#36B677"</span>, <span class="st">"#1F9D87"</span>, <span class="st">"#25818E"</span>, <span class="st">"#30678D"</span>, <span class="st">"#3D4988"</span>, <span class="st">"#462777"</span>, <span class="st">"#440154"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">xp_m</span><span class="op">$</span><span class="va">extrapolation</span>, main <span class="op">=</span> <span class="st">"Shape metric"</span>, col <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">xp_m</span><span class="op">$</span><span class="va">uni_comb</span>, main <span class="op">=</span> <span class="st">"Univariate (1) and \n combinatorial (2) extrapolation"</span>, col <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/comparison%20extrapolation%20outputs-1.png" width="672"></p>
<p>We can also explore extrapolation or suitability patterns in
environmental and geographic space, using just one function. To do that,
we will use the <a href="https://sjevelazco.github.io/flexsdm/reference/p_extra.html"><code>p_extra</code></a>
function. This function plots a ggplot object.</p>
<p>Let’s start with our extrapolation evaluation. These plots show that
areas with high extrapolation (dark blue) are far from the training data
(shown in black) in both environmental and geographic space.</p>
<p>The higher extrapolation values extrapolation area in the
northwestern portion of the CFP.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/p_extra.html">p_extra</a></span><span class="op">(</span></span>
<span>  training_data <span class="op">=</span> <span class="va">hespero_pa3</span>,</span>
<span>  x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>  y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>  pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>  color_p <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>  extra_suit_data <span class="op">=</span> <span class="va">xp_m</span>,</span>
<span>  projection_data <span class="op">=</span> <span class="va">somevar</span>,</span>
<span>  geo_space <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  prop_points <span class="op">=</span> <span class="fl">0.05</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of cell used to plot 3642 (5%)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/graphical%20explore%20-%20Mahalanobis-1.png" width="672"></p>
<p>Let’s explore univariate and combinatorial extrapolation. The former
is defined as the projecting data outside range of training conditions,
while the combinatorial extrapolation area those projecting data within
the range of training conditions.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/p_extra.html">p_extra</a></span><span class="op">(</span></span>
<span>  training_data <span class="op">=</span> <span class="va">hespero_pa3</span>,</span>
<span>  x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>  y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>  pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>  color_p <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>  extra_suit_data <span class="op">=</span> <span class="va">xp_m</span><span class="op">$</span><span class="va">uni_comb</span>,</span>
<span>  projection_data <span class="op">=</span> <span class="va">somevar</span>,</span>
<span>  geo_space <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  prop_points <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  color_gradient <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#B3DC2B"</span>, <span class="st">"#30678D"</span><span class="op">)</span>,</span>
<span>  alpha_p <span class="op">=</span> <span class="fl">0.2</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of cell used to plot 3642 (5%)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/graphical%20explore%20-%20uni_comb%20extrapolation-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="truncating-sdms-predictions-based-on-extrapolation-thresholds">Truncating SDMs predictions based on extrapolation thresholds<a class="anchor" aria-label="anchor" href="#truncating-sdms-predictions-based-on-extrapolation-thresholds"></a>
</h2>
<p>Depending on the user’s end goal, you may want to exclude suitability
values that are environmentally “too” far from modeling training data.
The Shape method allows you to select any extrapolation threshold to
exclude suitability values.</p>
<p>Before truncating our models we can use the <a href="https://sjevelazco.github.io/flexsdm/reference/p_extra.html"><code>p_extra</code></a>
function to explore binary extrapolation patter in the environmental and
geographical space. Here we will test the values 50, 100, and 500, for
comparison.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/p_extra.html">p_extra</a></span><span class="op">(</span></span>
<span>  training_data <span class="op">=</span> <span class="va">hespero_pa3</span>,</span>
<span>  x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>  y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>  pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>  color_p <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>  extra_suit_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">xp_m</span><span class="op">$</span><span class="va">extrapolation</span> <span class="op">&lt;</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>  projection_data <span class="op">=</span> <span class="va">somevar</span>,</span>
<span>  geo_space <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  prop_points <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  color_gradient <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gray"</span>, <span class="st">"#FDE725"</span><span class="op">)</span>,</span>
<span>  alpha_p <span class="op">=</span> <span class="fl">0.5</span></span>
<span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html" class="external-link">plot_annotation</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Binary extrapolation pattern with using a threshold of 50"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of cell used to plot 3642 (5%)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/explore%20extrapolation%20thresholds-1.png" width="672"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/p_extra.html">p_extra</a></span><span class="op">(</span></span>
<span>  training_data <span class="op">=</span> <span class="va">hespero_pa3</span>,</span>
<span>  x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>  y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>  pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>  color_p <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>  extra_suit_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">xp_m</span><span class="op">$</span><span class="va">extrapolation</span> <span class="op">&lt;</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  projection_data <span class="op">=</span> <span class="va">somevar</span>,</span>
<span>  geo_space <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  prop_points <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  color_gradient <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gray"</span>, <span class="st">"#FDE725"</span><span class="op">)</span>,</span>
<span>  alpha_p <span class="op">=</span> <span class="fl">0.5</span></span>
<span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html" class="external-link">plot_annotation</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Binary extrapolation pattern with using a threshold of 100"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of cell used to plot 3642 (5%)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/explore%20extrapolation%20thresholds-2.png" width="672"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/p_extra.html">p_extra</a></span><span class="op">(</span></span>
<span>  training_data <span class="op">=</span> <span class="va">hespero_pa3</span>,</span>
<span>  x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>  y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>  pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>  color_p <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>  extra_suit_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">xp_m</span><span class="op">$</span><span class="va">extrapolation</span> <span class="op">&lt;</span> <span class="fl">500</span><span class="op">)</span>,</span>
<span>  projection_data <span class="op">=</span> <span class="va">somevar</span>,</span>
<span>  geo_space <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  prop_points <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  color_gradient <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gray"</span>, <span class="st">"#FDE725"</span><span class="op">)</span>,</span>
<span>  alpha_p <span class="op">=</span> <span class="fl">0.5</span></span>
<span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_annotation.html" class="external-link">plot_annotation</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Binary extrapolation pattern with using a threshold of 500"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of cell used to plot 3642 (5%)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/explore%20extrapolation%20thresholds-3.png" width="672"></p>
<p>Values of 1 (yellow one) depict the environmental and geographical
regions will constraint our models suitability (truncate). Note that the
lower the threshold, the more restrictive the environmental and
geographic regions used to constrain the model.</p>
<p>Now we will use the function <a href="https://sjevelazco.github.io/flexsdm/reference/extra_truncate.html"><code>extra_truncate</code></a>
to truncate the suitability predictions made by GLM, GBM, and SVM based
on extrapolation thresholds explored previously. As a note, threshold
selection will be very user-dependent, but this function allows you to
select multiple thresholds at one time to compare outputs. Users can
also select a “trunc_value” within the extra_truncate function, that
specifies the value that should be assigned to those cells that exceed
the extrapolation threshold (also specified in the function). The
default is 0 but users could also choose another value for which to
reduce suitability.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glm_trunc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extra_truncate.html">extra_truncate</a></span><span class="op">(</span></span>
<span>  suit <span class="op">=</span> <span class="va">mpred</span><span class="op">$</span><span class="va">glm</span>,</span>
<span>  extra <span class="op">=</span> <span class="va">xp_m</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">500</span><span class="op">)</span>,</span>
<span>  trunc_value <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">gbm_trunc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extra_truncate.html">extra_truncate</a></span><span class="op">(</span></span>
<span>  suit <span class="op">=</span> <span class="va">mpred</span><span class="op">$</span><span class="va">gbm</span>,</span>
<span>  extra <span class="op">=</span> <span class="va">xp_m</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">500</span><span class="op">)</span>,</span>
<span>  trunc_value <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">svm_trunc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extra_truncate.html">extra_truncate</a></span><span class="op">(</span></span>
<span>  suit <span class="op">=</span> <span class="va">mpred</span><span class="op">$</span><span class="va">svm</span>,</span>
<span>  extra <span class="op">=</span> <span class="va">xp_m</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">500</span><span class="op">)</span>,</span>
<span>  trunc_value <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">glm_trunc</span><span class="op">$</span><span class="va">`50`</span>, main <span class="op">=</span> <span class="st">"GLM; extra threshold = 50"</span>, col <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">glm_trunc</span><span class="op">$</span><span class="va">`100`</span>, main <span class="op">=</span> <span class="st">"GLM; extra threshold = 100"</span>, col <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">glm_trunc</span><span class="op">$</span><span class="va">`500`</span>, main <span class="op">=</span> <span class="st">"GLM; extra threshold = 500"</span>, col <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">gbm_trunc</span><span class="op">$</span><span class="va">`50`</span>, main <span class="op">=</span> <span class="st">"GBM; extra threshold = 50"</span>, col <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">gbm_trunc</span><span class="op">$</span><span class="va">`100`</span>, main <span class="op">=</span> <span class="st">"GBM; extra threshold = 100"</span>, col <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">gbm_trunc</span><span class="op">$</span><span class="va">`500`</span>, main <span class="op">=</span> <span class="st">"GBM; extra threshold = 500"</span>, col <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">svm_trunc</span><span class="op">$</span><span class="va">`50`</span>, main <span class="op">=</span> <span class="st">"SVM; extra threshold = 50"</span>, col <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">svm_trunc</span><span class="op">$</span><span class="va">`100`</span>, main <span class="op">=</span> <span class="st">"SVM; extra threshold = 100"</span>, col <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">svm_trunc</span><span class="op">$</span><span class="va">`500`</span>, main <span class="op">=</span> <span class="st">"SVM; extra threshold = 500"</span>, col <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p><img src="v06_Extrapolation_example_files/figure-html/comparison%20truncated%20outputs-1.png" width="768"></p>
<p>Based on these maps, you can see that the lower the extrapolation
threshold, the more restricted the habitat suitability patterns, while
higher values retain a greater amount of suitable habitat. Selecting the
best threshold will depend on modeling goals and objectives, and .</p>
<p>Want to learn more about Shape and other extrapolation metrics? Read
the article “Velazco, S. J. E., Brooke, M. R., De Marco Jr., P., Regan,
H. M., &amp; Franklin, J. (2023). How far can I extrapolate my species
distribution model? Exploring Shape, a novel method. <em>Ecography</em>,
<em>11</em>, e06992. <a href="https://doi.org/10.1111/ecog.06992" class="external-link uri">https://doi.org/10.1111/ecog.06992</a>”</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Santiago J.E. Velazco, Brooke Rose, André F.A. Andrade, Ignacio Minoli, Janet Franklin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
