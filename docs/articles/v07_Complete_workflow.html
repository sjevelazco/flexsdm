<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Species distribution modeling for several species and climate change scenarios • flexsdm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Species distribution modeling for several species and climate change scenarios">
<meta name="google-site-verification" content="gcou8tqRTwNjZ_Mf1kbFgAzzUcY3OF-JB2sPRPTA56I">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">flexsdm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.8</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html" aria-label="Home"><span class="fa fa-home"></span> Home</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v01_pre_modeling.html">1. Overview of Pre-modeling functions</a></li>
    <li><a class="dropdown-item" href="../articles/v02_modeling.html">2. Overview of Modeling functions</a></li>
    <li><a class="dropdown-item" href="../articles/v03_post_modeling.html">3. Overview of Post-modeling functions</a></li>
    <li><a class="dropdown-item" href="../articles/v04_Red_fir_example.html">4. An example with Red Fir</a></li>
    <li><a class="dropdown-item" href="../articles/v05_Rare_species_example.html">5. Modeling a rare species</a></li>
    <li><a class="dropdown-item" href="../articles/v06_Extrapolation_example.html">6. Tools to explore extrapolation in SDMs</a></li>
    <li><a class="dropdown-item" href="../articles/v07_Complete_workflow.html">7. Modeling workflow for several species</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/pkg_citation.html">Citations</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/pkg_citation.html">Citations</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html"><span class="fa fa-newspaper-o"></span> News</a></li>
<li class="nav-item"><a class="nav-link" href="https://sjevelazco.github.io/flexsdm" aria-label="GitHub">GitHub</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/sjevelazco/flexsdm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Species distribution modeling for several species and climate change scenarios</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/sjevelazco/flexsdm/blob/HEAD/vignettes/v07_Complete_workflow.Rmd" class="external-link"><code>vignettes/v07_Complete_workflow.Rmd</code></a></small>
      <div class="d-none name"><code>v07_Complete_workflow.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This tutorial presents a complete workflow for species distribution
modeling (SDM) using the <code>flexsdm</code> R package. We’ll be
analyzing the distribution of palm species in South Brazil based on
occurrence data and environmental variables for different time periods.
The workflow demonstrates data preparation, model construction,
evaluation, prediction, including an assessment of extrapolation risk,
and output saving.</p>
<div class="section level3">
<h3 id="required-packages">Required packages<a class="anchor" aria-label="anchor" href="#required-packages"></a>
</h3>
<p>First, let’s install and load the required packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install and load required packages</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://sjevelazco.github.io/flexsdm">flexsdm</a></span><span class="op">)</span><span class="op">)</span> <span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"flexsdm"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"terra"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">geodata</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"geodata"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://dieghernan.github.io/tidyterra/" class="external-link">tidyterra</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"tidyterra"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://paleolimbot.github.io/ggspatial/" class="external-link">ggspatial</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"ggspatial"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"ggplot2"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"dplyr"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"tidyr"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"readr"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"sf"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/reshape" class="external-link">reshape2</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"reshape2"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"stringr"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"purrr"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"flexsdm"</span>, <span class="st">"terra"</span>, <span class="st">"geodata"</span>, <span class="st">"tidyterra"</span>, <span class="st">"ggplot2"</span>, <span class="st">"dplyr"</span>, <span class="st">"tidyr"</span>,</span>
<span>    <span class="st">"readr"</span>, <span class="st">"sf"</span>, <span class="st">"ggspatial"</span>, <span class="st">"reshape2"</span>, <span class="st">"stringr"</span>, <span class="st">"purrr"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="va">require</span>,</span>
<span>  character.only <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="directory-setup">1. Directory Setup<a class="anchor" aria-label="anchor" href="#directory-setup"></a>
</h2>
<p>First, let’s setup a directory for our project. This will create a
structured directory for storing data, models, and results. You can
adjust the <code>main_dir</code> to your preferred location. You can
also adjust the other parameters to your needs, but the defaults should
work well for most cases. The <code>projections</code> parameter is set
to <code>NULL</code> to use the default projections, but we are
specifying the projection scenarios we will use later. If you change the
scenarios you evaluate, be sure to change this part so that your file
structure is compatible with your project. This will ensure that you
have folders for each of your climate change scenarios in the
1_Inputs/2_Predictors/2_Projection and 2_Outputs/2_Projection folders.
The <code>algorithm</code> and <code>ensemble</code> parameters specify
the algorithms and ensemble methods to be used in the modeling process.
The <code>threshold</code> parameter is set to <code>FALSE</code>,
meaning we will not create separate folders for continuous and
thresholded map outputs – though this is an option.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Future scenarios (we will use the function geodata::cmip6_world() to download future climate data but this will be highly dependent on the source of your future data</span></span>
<span></span>
<span><span class="co"># Define scenario components</span></span>
<span><span class="va">ssps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"370"</span>, <span class="st">"585"</span><span class="op">)</span> <span class="co"># two Shared Socioeconomic Pathway scenarios</span></span>
<span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2041-2060"</span><span class="op">)</span> <span class="co"># just one time frame but you can have multiple</span></span>
<span><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CNRM-CM6-1"</span>, <span class="st">"MIROC6"</span><span class="op">)</span> <span class="co"># two climate models</span></span>
<span></span>
<span><span class="co"># Expand into all combinations</span></span>
<span><span class="va">scenarios</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">models</span>, ssp <span class="op">=</span> <span class="va">ssps</span>, time <span class="op">=</span> <span class="va">time</span>,</span>
<span>  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create identifiers for each scenario combination</span></span>
<span><span class="va">scenarios</span><span class="op">$</span><span class="va">filename</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">scenarios</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"-"</span>, <span class="st">""</span>, <span class="va">x</span><span class="op">[</span><span class="st">"model"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, <span class="st">"_"</span>,</span>
<span>    <span class="va">x</span><span class="op">[</span><span class="st">"ssp"</span><span class="op">]</span>, <span class="st">"_"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"-"</span>, <span class="st">"_"</span>, <span class="va">x</span><span class="op">[</span><span class="st">"time"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Let's create a directory to create a directory system to store models inputs and outputs</span></span>
<span><span class="va">temp_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># This directory is temporary. We advise using a non-temporary directory to keep outputs saved when you test or adapt these codes.</span></span>
<span><span class="va">proj_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">temp_dir</span>, <span class="st">"1_SDM"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">proj_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="va">proj_dir</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/sdm_directory.html">sdm_directory</a></span><span class="op">(</span></span>
<span>  main_dir <span class="op">=</span> <span class="va">proj_dir</span>,</span>
<span>  projections <span class="op">=</span> <span class="va">scenarios</span><span class="op">$</span><span class="va">filename</span>,</span>
<span>  algorithm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gam"</span>, <span class="st">"gau"</span>, <span class="st">"glm"</span>, <span class="st">"gbm"</span>, <span class="st">"max"</span>, <span class="st">"net"</span>, <span class="st">"raf"</span>, <span class="st">"svm"</span>, <span class="st">"mean"</span>, <span class="st">"median"</span><span class="op">)</span>,</span>
<span>  threshold <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  return_vector <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># You can now use the proj_dir object as a shortcut for saving outputs</span></span>
<span></span>
<span><span class="co"># It will be helpful to create a folder for saving figures</span></span>
<span><span class="co"># Figure directory</span></span>
<span><span class="va">dir_fig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">proj_dir</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"2_Outputs"</span>, <span class="st">"3_Figures"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir_fig</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Path to save data based on points (i.e. presences, pseudo-absences, and background points)</span></span>
<span><span class="va">points_dir</span> <span class="op">&lt;-</span> <span class="va">proj_dir</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"1_Inputs/1_Occurrences"</span><span class="op">)</span>,</span>
<span>  <span class="va">proj_dir</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">points_dir</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-species-occurrence-data">2. Load Species Occurrence Data<a class="anchor" aria-label="anchor" href="#load-species-occurrence-data"></a>
</h2>
<p>We will use occurrence data for palm species in South Brazil (<a href="https://doi.org/10.1016/j.pecon.2021.03.010" class="external-link">Calambás-Trochez et
al., 2021</a>). The data is available in flexsdm as internal data. We
will load this database and save it in “./1_Inputs/1_Occurrences”.</p>
<p>We begin by loading the palm species occurrence data and examining
its structure:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load palms occurrence data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">palms</span><span class="op">)</span></span>
<span><span class="va">palms</span></span>
<span></span>
<span><span class="co"># Save the data to a file ./1_SDM/1_Inputs/1_Occurrence</span></span>
<span><span class="va">points_dir</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">palms</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">points_dir</span>, <span class="st">"0_south_br_palms.txt"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load species data</span></span>
<span><span class="va">species_data</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">points_dir</span>, <span class="st">"0_south_br_palms.txt"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check the number of occurrences available for each species</span></span>
<span><span class="va">species_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">species_data</span><span class="op">$</span><span class="va">species</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">species_counts</span></span>
<span></span>
<span><span class="co"># Let's remove species with fewer than 15 occurrences</span></span>
<span><span class="va">species_data</span> <span class="op">&lt;-</span> <span class="va">species_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">15</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot occurrence points to visualize the data</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">species_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">species</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Palm species occurrences in Southern Brazil"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">species</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="environmental-data">3. Environmental Data<a class="anchor" aria-label="anchor" href="#environmental-data"></a>
</h2>
<p>We’ll download WorldClim bioclimatic variables as our environmental
predictors (1970-2000). The bounding box can be adjusted based on your
study extent.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define area of interest (bounding box for South Brazil)</span></span>
<span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">70</span>, <span class="op">-</span><span class="fl">30</span>, <span class="op">-</span><span class="fl">36</span>, <span class="op">-</span><span class="fl">5</span><span class="op">)</span> <span class="co"># xmin, xmax, ymin, ymax &lt;- define this based on your study extent of all your species</span></span>
<span></span>
<span><span class="co"># If you have a polygon for your study extent, you can define like bbox &lt;- st_bbox(study_extent)</span></span>
<span></span>
<span><span class="co"># Download WorldClim bioclimatic variables at 10 arc-minutes resolution (you can adjust the spatial resolution with the res argument)</span></span>
<span><span class="va">env_data</span> <span class="op">&lt;-</span> <span class="fu">geodata</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geodata/man/worldclim.html" class="external-link">worldclim_global</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">"bio"</span>, res <span class="op">=</span> <span class="fl">10</span>, path <span class="op">=</span> <span class="va">temp_dir</span><span class="op">)</span> <span class="co"># tempdir()</span></span>
<span></span>
<span><span class="co"># Crop to our area of interest -- retain all variables for now -- we will correct for multicollinearity later</span></span>
<span><span class="va">env_data</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">env_data</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Clean variables names</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">env_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">env_data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"wc2.1_10m_"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot a raster layers and points</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">env_data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">species_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save raster for current conditions</span></span>
<span><span class="va">env_path</span> <span class="op">&lt;-</span> <span class="va">proj_dir</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"1_Inputs/2_Predictors/1_Current"</span><span class="op">)</span>,</span>
<span>  <span class="va">proj_dir</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">env_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">env_path</span>, <span class="st">"bio_var.tif"</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot the environmental variables</span></span>
<span><span class="co"># ---- Temperature Variables (1–11) ----</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">env_data</span><span class="op">[[</span><span class="fl">1</span><span class="op">:</span><span class="fl">11</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Annual Mean Temperature"</span>,</span>
<span>    <span class="st">"Mean Diurnal Range"</span>,</span>
<span>    <span class="st">"Isothermality"</span>,</span>
<span>    <span class="st">"Temperature Seasonality"</span>,</span>
<span>    <span class="st">"Max Temperature of Warmest Month"</span>,</span>
<span>    <span class="st">"Min Temperature of Coldest Month"</span>,</span>
<span>    <span class="st">"Temperature Annual Range"</span>,</span>
<span>    <span class="st">"Mean Temperature of Wettest Quarter"</span>,</span>
<span>    <span class="st">"Mean Temperature of Driest Quarter"</span>,</span>
<span>    <span class="st">"Mean Temperature of Warmest Quarter"</span>,</span>
<span>    <span class="st">"Mean Temperature of Coldest Quarter"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># ---- Precipitation Variables (12–19) ----</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">env_data</span><span class="op">[[</span><span class="fl">12</span><span class="op">:</span><span class="fl">19</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Annual Precipitation"</span>,</span>
<span>    <span class="st">"Precipitation of Wettest Month"</span>,</span>
<span>    <span class="st">"Precipitation of Driest Month"</span>,</span>
<span>    <span class="st">"Precipitation Seasonality"</span>,</span>
<span>    <span class="st">"Precipitation of Wettest Quarter"</span>,</span>
<span>    <span class="st">"Precipitation of Driest Quarter"</span>,</span>
<span>    <span class="st">"Precipitation of Warmest Quarter"</span>,</span>
<span>    <span class="st">"Precipitation of Coldest Quarter"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now let’s download the same variables for our future scenarios using
geodata::cmip6</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Download future climate change projecitons of the bioclim variables</span></span>
<span><span class="va">fut_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">scenarios</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">scenarios</span><span class="op">$</span><span class="va">filename</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">fut</span> <span class="op">&lt;-</span> <span class="fu">geodata</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geodata/man/cmip6.html" class="external-link">cmip6_world</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">scenarios</span><span class="op">$</span><span class="va">model</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>    ssp <span class="op">=</span> <span class="va">scenarios</span><span class="op">$</span><span class="va">ssp</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>    time <span class="op">=</span> <span class="va">scenarios</span><span class="op">$</span><span class="va">time</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>    var <span class="op">=</span> <span class="st">"bioc"</span>,</span>
<span>    res <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">fut_env</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">fut</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">)</span><span class="op">)</span> <span class="co"># if you want your future data cropped to the extent we defined earlier</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fut_env</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"bio_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nlyr</a></span><span class="op">(</span><span class="va">fut_env</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">temp_dir</span>, <span class="st">"1_SDM/1_Inputs/2_Predictors/2_Projection"</span>, <span class="va">scenarios</span><span class="op">$</span><span class="va">filename</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Save raster for future scenario</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">fut_env</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">path</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">scenarios</span><span class="op">$</span><span class="va">filename</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"_bio_var.tif"</span><span class="op">)</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fut_env</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">scenarios</span><span class="op">$</span><span class="va">filename</span></span>
<span></span>
<span><span class="co"># Compare bio1 across the four scenarios</span></span>
<span><span class="co"># Get global min/max for bio_1 across all scenarios</span></span>
<span><span class="va">bio1_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fut_env</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/minmax.html" class="external-link">minmax</a></span><span class="op">(</span><span class="va">r</span><span class="op">[[</span><span class="st">"bio_1"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set up plotting window (2x2 for 4 scenarios)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot with consistent zlim</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">fut_env</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fut_env</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"bio_1"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    main <span class="op">=</span> <span class="va">scenarios</span><span class="op">$</span><span class="va">filename</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>    zlim <span class="op">=</span> <span class="va">bio1_range</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-species-training-area">4. Define species training area<a class="anchor" aria-label="anchor" href="#define-species-training-area"></a>
</h2>
<p>We will define a training area (a.k.a. calibration area or accessible
area) for each species based on its occurrence data. This area will be
used to extract environmental values and to create pseudo-absences
later.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A vector with species names that will be modeled</span></span>
<span><span class="va">sp_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">species_data</span><span class="op">$</span><span class="va">species</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Directory to save training areas to shapefiles</span></span>
<span><span class="va">calib_dir</span> <span class="op">&lt;-</span> <span class="va">proj_dir</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"1_Inputs/3_Calibration_area"</span><span class="op">)</span>, <span class="va">proj_dir</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">calib_dir</span></span>
<span></span>
<span></span>
<span><span class="co"># Create training areas for each species</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Creating training area for species: "</span>, <span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co"># Define training area for the i-th species</span></span>
<span>  <span class="va">ca</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_area.html">calib_area</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">species_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"buffer"</span>, width <span class="op">=</span> <span class="fl">300000</span><span class="op">)</span>, <span class="co"># 300 km around presences</span></span>
<span>    crs <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">env_data</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Save shapefile with tranning area</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeVector.html" class="external-link">writeVector</a></span><span class="op">(</span></span>
<span>    <span class="va">ca</span>,</span>
<span>    filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">calib_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">".gpkg"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    overwrite <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Check the training areas in the directory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">calib_dir</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="evaluate-species-specific-multicollinearity">5. Evaluate Species-Specific Multicollinearity<a class="anchor" aria-label="anchor" href="#evaluate-species-specific-multicollinearity"></a>
</h2>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract environmental values at species occurrence points</span></span>
<span><span class="va">species_env</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/sdm_extract.html">sdm_extract</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">species_data</span>,</span>
<span>  x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>  y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>  env_layer <span class="op">=</span> <span class="va">env_data</span>,</span>
<span>  filter_na <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sp_names</span> <span class="co"># Vector with species to be modeled</span></span>
<span></span>
<span><span class="co"># List of species data frames</span></span>
<span><span class="va">species_data_list</span> <span class="op">&lt;-</span> <span class="va">species_env</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pr_ab <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html" class="external-link">group_split</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">species_data_list</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">sp_names</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">species_data_list</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Vector with variable names</span></span>
<span><span class="va">var_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">env_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># First let's visualize predictor collinearity at species' occurrences for each species</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cor_data</span> <span class="op">&lt;-</span> <span class="va">species_env</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">var_names</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span>use <span class="op">=</span> <span class="st">"pairwise.complete.obs"</span>, method <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">cor_data</span> <span class="op">&lt;-</span> <span class="va">cor_data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cor_data</span><span class="op">$</span><span class="va">Var1</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cor_data</span><span class="op">$</span><span class="va">Var2</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">cor_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Var1</span>, y <span class="op">=</span> <span class="va">Var2</span>, fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient2</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"blue"</span>, mid <span class="op">=</span> <span class="st">"white"</span>, high <span class="op">=</span> <span class="st">"red"</span>, midpoint <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.2f"</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>      title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Correlation: "</span>, <span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      fill <span class="op">=</span> <span class="st">"Correlation"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>      axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>      axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># save each heatmap (adjust file path as needed)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span></span>
<span>    filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_fig</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"_correlation_heatmap.png"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">8</span>, height <span class="op">=</span> <span class="fl">6</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="correct-multicollinearity">6. Correct Multicollinearity<a class="anchor" aria-label="anchor" href="#correct-multicollinearity"></a>
</h2>
<p>For this step, we will use the correct_colinvar function in flexsdm.
There are several methods for correcting multicollinarity among
environmental predictors, including setting a maximum correlation
threshold (0.7 is a common choice), variance inflation factor (VIF),
factorial analysis, and principal component analysis (PCA) (checkout out
<a href="https://sjevelazco.github.io/flexsdm/reference/correct_colinvar.html"><code>correct_colinvar</code></a>
function). The method you select strongly depends on the ultimate goals
of your SDM. If you want to better understand and compare the influence
of different environmental drivers on your species distributions,
retaining the original environmental factors can be beneficial. If
prediction is the primary goal, PCA can be a good option as it reduces
dimensionality while retaining most of the variance in the data. Here we
will use PCA performed for each species training area. This method will
generate an environmental layer of principal components used to model
each species. This function will also allow you to project the principal
components of the PCA for future environmental conditions, if desired.
Note that this other multicollinearity approaches can be based on entire
environmental layers, for a given training area, or based species points
(presences+absences or pseudo-absences).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># (Optional) Access the help page for the function to learn more about its parameters:</span></span>
<span><span class="co"># ?correct_colinvar</span></span>
<span></span>
<span><span class="co"># Generate a list of file paths to each species' training area.</span></span>
<span><span class="co"># Each training area is stored as a .gpkg (GeoPackage) file in calib_dir.</span></span>
<span><span class="va">calib_a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">calib_dir</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, pattern <span class="op">=</span> <span class="st">".gpkg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign species names as the names of the elements in calib_a for easy reference.</span></span>
<span><span class="co"># This extracts the file name without the ".gpkg" extension and sets it as the list name.</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">calib_a</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">calib_a</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".gpkg"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the named vector to verify the paths and their associated species names.</span></span>
<span><span class="va">calib_a</span></span>
<span></span>
<span><span class="co"># --- Demonstrate the process for all species ----</span></span>
<span></span>
<span></span>
<span><span class="co"># -----------------------------------------------------------</span></span>
<span><span class="co"># Example: Running PCA-based collinearity correction</span></span>
<span><span class="co">#          for multiple species across multiple scenarios</span></span>
<span><span class="co"># -----------------------------------------------------------</span></span>
<span></span>
<span><span class="co"># List training area polygons (.gpkg files)</span></span>
<span><span class="va">calib_a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">calib_dir</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, pattern <span class="op">=</span> <span class="st">".gpkg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign species names to each element for reference</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">calib_a</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">calib_a</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".gpkg"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect what we have</span></span>
<span><span class="va">calib_a</span></span>
<span></span>
<span><span class="co"># --- Demonstrate the process for a single species (the first one) ---</span></span>
<span></span>
<span><span class="co"># Load the vector (polygon) corresponding to the first species’ training area.</span></span>
<span><span class="co"># This will be used to restrict PCA to the relevant region.</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">calib_a</span><span class="op">[</span><span class="va">sp_names</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the training area polygon to visually confirm it's correct.</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the correct_colinvar function to reduce multicollinearity among predictors for this species.</span></span>
<span><span class="co"># - env_layer: the stack of environmental predictor rasters.</span></span>
<span><span class="co"># - restric_to_region: restricts the analysis to the training area polygon.</span></span>
<span><span class="co"># - restric_pca_proj: ensures PCA is projected only within the training area.</span></span>
<span><span class="co"># - method: use "pca" (Principal Component Analysis) for dimensionality reduction.</span></span>
<span><span class="co"># - based_on_points: FALSE means PCA is based on the entire environmental layer within the region, not just the occurrence points.</span></span>
<span><span class="va">pca_out</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/correct_colinvar.html">correct_colinvar</a></span><span class="op">(</span></span>
<span>  env_layer <span class="op">=</span> <span class="va">env_data</span>,</span>
<span>  restric_to_region <span class="op">=</span> <span class="va">v</span>, <span class="co"># Restrict to the training area polygon</span></span>
<span>  restric_pca_proj <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># Apply PCA projection only to the training area</span></span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pca"</span><span class="op">)</span>, <span class="co"># Use Principal Component Analysis</span></span>
<span>  based_on_points <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># Base PCA on environmental data, not just points</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the results of the PCA correction to examine the structure of the output object.</span></span>
<span><span class="va">pca_out</span></span>
<span></span>
<span><span class="co"># Plot the resulting raster of principal components.</span></span>
<span><span class="co"># This raster will be used as the new, uncorrelated set of predictors for SDM for this species.</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pca_out</span><span class="op">$</span><span class="va">env_layer</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display the cumulative variance explained by each principal component.</span></span>
<span><span class="co"># This helps determine how many components are needed to capture most of the environmental variation.</span></span>
<span><span class="va">pca_out</span><span class="op">$</span><span class="va">cumulative_variance</span></span>
<span></span>
<span><span class="co"># Show the PCA loadings (coefficients) for each original variable.</span></span>
<span><span class="co"># These indicate the contribution of each environmental variable to each principal component.</span></span>
<span><span class="va">pca_out</span><span class="op">$</span><span class="va">coefficients</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="process-environmental-pca-for-all-species">7. Process environmental PCA for all species<a class="anchor" aria-label="anchor" href="#process-environmental-pca-for-all-species"></a>
</h2>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Lets create a new folder to store variables of each species</span></span>
<span><span class="va">save_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">proj_dir</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">"4_Predictors_by_sp"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">save_dir</span><span class="op">)</span></span>
<span><span class="va">save_dir</span></span>
<span></span>
<span><span class="co"># path with future scenarios</span></span>
<span><span class="va">scenario_path</span> <span class="op">&lt;-</span> <span class="va">proj_dir</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"1_Inputs/2_Predictors/2_Projection"</span><span class="op">)</span>, <span class="va">proj_dir</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Separate directories for current and future</span></span>
<span><span class="va">folders</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1_Current"</span>, <span class="st">"2_Projection"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create subfolders inside the base folder</span></span>
<span><span class="va">folder_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">folders</span>, <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dir_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">save_dir</span>, <span class="va">f</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">dir_path</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dir_path</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">dir_path</span> <span class="co"># return the created path</span></span>
<span><span class="op">}</span>, USE.NAMES <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">env_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Perform PCA for each species and save the outputs</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Processing species: "</span>, <span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">v</span> <span class="op">&lt;-</span> <span class="va">calib_a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># species-specific predictor projection folders</span></span>
<span></span>
<span>  <span class="va">fut_folder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">folder_paths</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">fut_folder</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co"># Run PCA collinearity correction</span></span>
<span>  <span class="va">env_new</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/correct_colinvar.html">correct_colinvar</a></span><span class="op">(</span></span>
<span>    env_layer <span class="op">=</span> <span class="va">env_data</span>,</span>
<span>    proj <span class="op">=</span> <span class="va">scenario_path</span>,</span>
<span>    save_proj <span class="op">=</span> <span class="va">fut_folder</span>,</span>
<span>    restric_to_region <span class="op">=</span> <span class="va">v</span>,</span>
<span>    restric_pca_proj <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"pca"</span>,</span>
<span>    based_on_points <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Save tables</span></span>
<span></span>
<span>  <span class="va">env_new</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">cumulative_variance</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">folder_paths</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"-cum_var.txt"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">env_new</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">coefficients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">folder_paths</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"-coefficients.txt"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Saver raster for current conditions</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span><span class="va">env_new</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">env_layer</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">folder_paths</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">".tif"</span><span class="op">)</span><span class="op">)</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>These principal components will be used as uncorrelated predictors in
SDMs. To interpret ecological meaning of each PC, explore the loading
coefficients—e.g., a PC heavily influenced by bio1, bio5, and bio6 may
represent a temperature gradient.</p>
</div>
<div class="section level2">
<h2 id="occurrence-sample-bias-correction">8. Occurrence Sample Bias Correction<a class="anchor" aria-label="anchor" href="#occurrence-sample-bias-correction"></a>
</h2>
<p>To improve SDM robustness and reduce the influence of spatial and
environmental sampling bias, we can filter species occurrence records in
environmental space using PCA-reduced environmental variables. The
process is implemented below in three main steps for each species.
First, we prepare inputs using species-specific occurrences
(species_data_list) and PCA-reduced environmental layers
(pca_env_selected), cropped to training areas (ca). Next, we use
occfilt_env() to filter occurrences across a range of environmental bin
sizes (e.g., 8–30). Finally, we select the optimal bin size using
occfilt_select(), based on reducing spatial autocorrelation and
maximizing the number of occurrences retained. This approach is
implemented and described in detail in Velazco et al. (2020).</p>
<p>The plot illustrates how mean spatial autocorrelation changes with
the number of environmental bins used for filtering occurrence data.
Each line represents a different species. As the number of bins
increases, the spatial filtering becomes finer, increasing the number of
occurrences included as well as the spatial clustering of those
occurrences. The plot highlights the number of environmental bins and
number of occurrence records (denoted with *) that were selected. Lower
values on the y-axis indicate greater spatial independence among
records, which is typically preferred for model training.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 'species_data' holds all occurrence records for all species to be modeled.</span></span>
<span><span class="va">species_data</span> <span class="co"># Data frame: species names, coordinates, etc.</span></span>
<span></span>
<span><span class="co"># 'sp_names' contains the names of the species to be included in the analysis.</span></span>
<span><span class="va">sp_names</span> <span class="co"># Character vector: species to process</span></span>
<span></span>
<span><span class="co"># 'save_dir' is the directory where each species' PCA-reduced environmental predictor files are saved.</span></span>
<span><span class="va">save_dir</span> <span class="co"># Path to directory with species-specific predictors</span></span>
<span></span>
<span><span class="co"># 'folders' are the directories where the PCA-reduced environmental predictors are split between Current and Projections</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">save_dir</span>, <span class="va">folders</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># List all .tif files in folders (one per species, each containing PCA environmental layers for the baseline time).</span></span>
<span><span class="va">sp_pc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">save_dir</span>, <span class="va">folders</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, pattern <span class="op">=</span> <span class="st">".tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign species names to each file in 'sp_pc' by removing the '.tif' extension from the filename.</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sp_pc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">sp_pc</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".tif"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span> <span class="co"># Now names(sp_pc) matches sp_names</span></span>
<span></span>
<span><span class="co"># Print the named vector to verify that the PCA files are matched to the correct species.</span></span>
<span><span class="va">sp_pc</span> <span class="co"># Named vector: path to each species' PCA raster</span></span>
<span></span>
<span><span class="co"># Initialize empty lists to store filtered occurrences and bin selection results for each species.</span></span>
<span><span class="va">filtered_occurrences</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">bins_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loop over each species to perform occurrence thinning in environmental space.</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Filtering occurrences for species: "</span>, <span class="va">s</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Extract occurrence data for the current species.</span></span>
<span>  <span class="va">occ_data</span> <span class="op">&lt;-</span> <span class="va">species_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="va">sp_names</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Add a unique identifier to each occurrence record (required for filtering).</span></span>
<span>  <span class="va">occ_data</span><span class="op">$</span><span class="va">idd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">occ_data</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Load the PCA-reduced environmental raster for this species.</span></span>
<span>  <span class="va">env_data</span> <span class="op">&lt;-</span> <span class="va">sp_pc</span><span class="op">[</span><span class="va">sp_names</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Filter occurrences in environmental space using a range of bin numbers.</span></span>
<span>  <span class="co"># This step thins points so that only one point is retained per environmental bin, reducing sampling bias.</span></span>
<span>  <span class="va">filtered_dif_bins</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/occfilt_env.html">occfilt_env</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">occ_data</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    id <span class="op">=</span> <span class="st">"idd"</span>,</span>
<span>    env_layer <span class="op">=</span> <span class="va">env_data</span>,</span>
<span>    nbins <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">10</span>, <span class="fl">12</span>, <span class="fl">14</span>, <span class="fl">18</span>, <span class="fl">20</span>, <span class="fl">24</span>, <span class="fl">26</span>, <span class="fl">30</span><span class="op">)</span> <span class="co"># Try different numbers of bins</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Select the optimal bin size (trade-off between spatial independence and number of retained records).</span></span>
<span>  <span class="co"># The function returns the filtered occurrences and summary statistics for each bin size.</span></span>
<span>  <span class="va">occ_selected</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/occfilt_select.html">occfilt_select</a></span><span class="op">(</span></span>
<span>    occ_list <span class="op">=</span> <span class="va">filtered_dif_bins</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    env_layer <span class="op">=</span> <span class="va">env_data</span>,</span>
<span>    filter_prop <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># Optimize for spatial independence and number of points retained</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Save the filtered occurrences and bin selection results for this species.</span></span>
<span>  <span class="va">filtered_occurrences</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">occ_selected</span><span class="op">$</span><span class="va">occ</span></span>
<span>  <span class="va">bins_results</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">occ_selected</span><span class="op">$</span><span class="va">filter_prop</span></span>
<span></span>
<span>  <span class="co"># Clean up memory (especially useful in large loops).</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Assign species names as list names for easier downstream handling.</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">filtered_occurrences</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">sp_names</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">bins_results</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">sp_names</span></span>
<span></span>
<span><span class="co"># Combine filtered occurrences from all species into a single data frame with a 'species' column.</span></span>
<span><span class="va">filtered_occurrences</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">filtered_occurrences</span>, .id <span class="op">=</span> <span class="st">"species"</span><span class="op">)</span></span>
<span><span class="va">filtered_occurrences</span></span>
<span></span>
<span><span class="co"># Combine bin selection summaries for all species into a single data frame.</span></span>
<span><span class="va">bins_results</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">bins_results</span>, .id <span class="op">=</span> <span class="st">"species"</span><span class="op">)</span></span>
<span><span class="va">bins_results</span></span>
<span></span>
<span><span class="co"># Save bin selection results and filtered occurrences to tab-separated files for reproducibility and downstream use.</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">bins_results</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">points_dir</span>, <span class="st">"0_filt_prop_selected.txt"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">filtered_occurrences</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">points_dir</span>, <span class="st">"0_occurrences_filtered.txt"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare the number of original (unfiltered) and filtered occurrence records per species.</span></span>
<span><span class="co"># This helps assess how much data was removed by the filtering process.</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>  <span class="va">species_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>unfiltered <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="va">filtered_occurrences</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>filtered <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"species"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="sample-pseudo-absences-background-points">9. Sample Pseudo-Absences &amp; Background points<a class="anchor" aria-label="anchor" href="#sample-pseudo-absences-background-points"></a>
</h2>
<p>In SDM, we often need to generate pseudo-absence points to be able
use some algorithm (e.g., SVM, RAF). Here, we will create pseudo-absence
points for each species based on the training area defined earlier. We
will also generate background points for Maxent.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the filtered occurrence data from file.</span></span>
<span><span class="co"># This table contains the bias-corrected presence records for all species.</span></span>
<span><span class="va">filtered_occurrences</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">proj_dir</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">"1_Occurrences/0_occurrences_filtered.txt"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add a column indicating presences (pr_ab = 1), as all records here are presences.</span></span>
<span><span class="va">filtered_occurrences</span><span class="op">$</span><span class="va">pr_ab</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># Prepare to load environmental PCA predictors for each species.</span></span>
<span><span class="co"># Find all .tif files in the '4_Predictors_by_sp' directory (one per species).</span></span>
<span><span class="va">sp_pc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">proj_dir</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">"4_Predictors_by_sp/1_Current/"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">.</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, pattern <span class="op">=</span> <span class="st">".tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set the names of the vector to the species names (by stripping ".tif" extension from the file names).</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sp_pc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">sp_pc</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".tif$"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print out the named vector to confirm the mapping of species to file paths.</span></span>
<span><span class="va">sp_pc</span></span>
<span></span>
<span><span class="co"># Initialize empty lists to store results for all species:</span></span>
<span><span class="co">#   - pres_pabsences: for data with presences and pseudo-absences</span></span>
<span><span class="co">#   - background: for background points (for Maxent models)</span></span>
<span><span class="va">pres_pabsences</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">background</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loop over each species to generate pseudo-absences and background points.</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"species "</span>, <span class="va">i</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Extract filtered occurrence records for the current species.</span></span>
<span>  <span class="va">coord</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">filtered_occurrences</span>, <span class="va">species</span> <span class="op">==</span> <span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Load the PCA-reduced environmental raster for the current species.</span></span>
<span>  <span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">sp_pc</span><span class="op">[</span><span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span> <span class="co"># Set random seed for reproducibility.</span></span>
<span></span>
<span>  <span class="co"># Generate pseudo-absence points for the current species.</span></span>
<span>  <span class="co"># n = twice the number of presences (a common SDM practice).</span></span>
<span>  <span class="co"># Points are sampled randomly within the valid region of the predictor raster.</span></span>
<span>  <span class="va">pres_pabsences</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/sample_pseudoabs.html">sample_pseudoabs</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">coord</span>,</span>
<span>      x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>      y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>      n <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">coord</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span>, <span class="co"># 2x number of presences</span></span>
<span>      method <span class="op">=</span> <span class="st">"random"</span>, <span class="co"># Random selection</span></span>
<span>      rlayer <span class="op">=</span> <span class="va">pred</span> <span class="co"># Within the species-specific training area</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      species <span class="op">=</span> <span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="co"># Label with species name</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">coord</span>, <span class="va">.</span><span class="op">)</span> <span class="co"># Combine presences and pseudo-absences</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span> <span class="co"># Reset seed for reproducibility.</span></span>
<span></span>
<span>  <span class="co"># Generate 10,000 random background points for the current species (for Maxent).</span></span>
<span>  <span class="va">background</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/sample_background.html">sample_background</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">coord</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    n <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"random"</span>,</span>
<span>    rlayer <span class="op">=</span> <span class="va">pred</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      species <span class="op">=</span> <span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Assign species names to each list element for easy reference later.</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">background</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">sp_names</span></span>
<span></span>
<span><span class="co"># Combine the lists of data frames into single data frames for all species.</span></span>
<span><span class="va">pres_pabsences</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">pres_pabsences</span><span class="op">)</span></span>
<span><span class="va">background</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">background</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save the combined presence + pseudo-absence data and background data to disk as .txt files.</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">pres_pabsences</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">points_dir</span>, <span class="st">"0_occurrences_psabsences.txt"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">background</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">points_dir</span>, <span class="st">"0_background.txt"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This section generates maps visualizing the spatial distribution of:</span></span>
<span><span class="co">#   1) species presence locations,</span></span>
<span><span class="co">#   2) pseudo-absence points, and</span></span>
<span><span class="co">#   3) background points for each species.</span></span>
<span><span class="co"># The resulting maps will help to visually assess the sampling design and spatial coverage of your data.</span></span>
<span></span>
<span><span class="va">dir_fig</span> <span class="co"># Directory where figure files will be saved</span></span>
<span></span>
<span><span class="co"># List all training area shapefiles (.gpkg) for each species.</span></span>
<span><span class="co"># These polygons define the modeling extent (calibration area) for each species.</span></span>
<span><span class="va">calib_a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">calib_dir</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, pattern <span class="op">=</span> <span class="st">".gpkg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign species names to each element of the calib_a vector,</span></span>
<span><span class="co"># by extracting the filename and removing the ".gpkg" extension.</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">calib_a</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">calib_a</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".gpkg"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loop through species and generate maps</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Isolate species data</span></span>
<span>  <span class="va">pa_data</span> <span class="op">&lt;-</span> <span class="va">pres_pabsences</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">bg_data</span> <span class="op">&lt;-</span> <span class="va">background</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">ca</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">calib_a</span><span class="op">[</span><span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Plot</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/ggspatvector.html" class="external-link">geom_spatvector</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ca</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">bg_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"gray60"</span>, size <span class="op">=</span> <span class="fl">0.7</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pa_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/is.bool.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">pr_ab</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span></span>
<span>      values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1"</span> <span class="op">=</span> <span class="st">"blue"</span>, <span class="st">"0"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>,</span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>      title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Species:"</span>, <span class="va">sp_names</span><span class="op">)</span>,</span>
<span>      subtitle <span class="op">=</span> <span class="st">"Blue = Presence | Red = Pseudo-Absence | Gray = Background"</span>,</span>
<span>      x <span class="op">=</span> <span class="st">"Longitude"</span>, y <span class="op">=</span> <span class="st">"Latitude"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/annotation_scale.html" class="external-link">annotation_scale</a></span><span class="op">(</span>location <span class="op">=</span> <span class="st">"br"</span>, width_hint <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/annotation_north_arrow.html" class="external-link">annotation_north_arrow</a></span><span class="op">(</span></span>
<span>      location <span class="op">=</span> <span class="st">"bl"</span>,</span>
<span>      style <span class="op">=</span> <span class="va">north_arrow_fancy_orienteering</span>,</span>
<span>      height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="st">"cm"</span><span class="op">)</span>,</span>
<span>      width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="st">"cm"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Print the plot to the console</span></span>
<span>  <span class="va">p</span></span>
<span></span>
<span>  <span class="co"># Save</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span></span>
<span>    filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_fig</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"_pr-ab-bg_map.png"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    plot <span class="op">=</span> <span class="va">p</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">8</span>, height <span class="op">=</span> <span class="fl">6</span>, dpi <span class="op">=</span> <span class="fl">300</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-partitioning">10. Data Partitioning<a class="anchor" aria-label="anchor" href="#data-partitioning"></a>
</h2>
<p>To properly evaluate our models, we’ll partition the data into
training and testing sets using spatial block or band partitioning.
Often blocks work for larger occurrence datasets, while bands can be
useful for smaller datasets. Here we try spatial blocks and move to
bands in case that fails.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Initialize lists to store partitioned data for each species.</span></span>
<span><span class="co"># - partitioned_psa: will hold partitioned presence and pseudo-absence records.</span></span>
<span><span class="co"># - partitioned_bg: will hold partitioned background points.</span></span>
<span><span class="va">partitioned_psa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">partitioned_bg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loop through each species to perform spatial partitioning for cross-validation.</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Processing spatial partitioning for: "</span>, <span class="va">i</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Select presence + pseudo-absence data for the current species.</span></span>
<span>  <span class="va">psa_select</span> <span class="op">&lt;-</span> <span class="va">pres_pabsences</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Select background points for the current species.</span></span>
<span>  <span class="va">bg_select</span> <span class="op">&lt;-</span> <span class="va">background</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Load PCA-reduced environmental raster for the species (used for spatial partitioning).</span></span>
<span>  <span class="va">env_subset</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">sp_pc</span><span class="op">[</span><span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Attempt spatial partitioning using spatial blocks (grids).</span></span>
<span>  <span class="co"># This method divides the study area into blocks, assigning data in each block to the same fold.</span></span>
<span>  <span class="va">part</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/part_sblock.html">part_sblock</a></span><span class="op">(</span></span>
<span>      env_layer <span class="op">=</span> <span class="va">env_subset</span>,</span>
<span>      data <span class="op">=</span> <span class="va">psa_select</span>,</span>
<span>      x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>      y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>      pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>      n_part <span class="op">=</span> <span class="fl">4</span>, <span class="co"># Number of partitions/folds</span></span>
<span>      min_res_mult <span class="op">=</span> <span class="fl">4</span>, <span class="co"># Controls minimum block size (relative to raster resolution)</span></span>
<span>      max_res_mult <span class="op">=</span> <span class="fl">300</span>, <span class="co"># Controls maximum block size</span></span>
<span>      num_grids <span class="op">=</span> <span class="fl">60</span>, <span class="co"># Number of candidate grids to test</span></span>
<span>      min_occ <span class="op">=</span> <span class="fl">5</span>, <span class="co"># Minimum number of occurrences per fold</span></span>
<span>      prop <span class="op">=</span> <span class="fl">0.9</span> <span class="co"># Proportion of data to be included in the partition (for exclusion of sparse blocks)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># If block partitioning fails (e.g., too few records per block), try latitudinal bands.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">part</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">part</span> <span class="op">&lt;-</span></span>
<span>      <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/part_sband.html">part_sband</a></span><span class="op">(</span></span>
<span>        env_layer <span class="op">=</span> <span class="va">env_subset</span>,</span>
<span>        data <span class="op">=</span> <span class="va">psa_select</span>,</span>
<span>        x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>        y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"lat"</span>, <span class="co"># Split into horizontal (latitudinal) bands</span></span>
<span>        n_part <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        min_bands <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        max_bands <span class="op">=</span> <span class="fl">60</span>,</span>
<span>        min_occ <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        prop <span class="op">=</span> <span class="fl">0.9</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># If latitudinal bands also fail, try longitudinal bands.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">part</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">part</span> <span class="op">&lt;-</span></span>
<span>      <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/part_sband.html">part_sband</a></span><span class="op">(</span></span>
<span>        env_layer <span class="op">=</span> <span class="va">env_subset</span>,</span>
<span>        data <span class="op">=</span> <span class="va">psa_select</span>,</span>
<span>        x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>        y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"lon"</span>, <span class="co"># Split into vertical (longitudinal) bands</span></span>
<span>        n_part <span class="op">=</span> <span class="fl">4</span>,</span>
<span>        min_bands <span class="op">=</span> <span class="fl">2</span>,</span>
<span>        max_bands <span class="op">=</span> <span class="fl">60</span>,</span>
<span>        min_occ <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        prop <span class="op">=</span> <span class="fl">0.9</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># If all spatial partitioning methods fail, revert to standard random k-fold partitioning.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">part</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Randomly assign presences/pseudo-absences to 5 folds.</span></span>
<span>    <span class="va">partitioned_psa</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/part_random.html">part_random</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">psa_select</span>,</span>
<span>      pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>      method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"kfold"</span>, folds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Randomly assign background points to 5 folds.</span></span>
<span>    <span class="va">partitioned_bg</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/part_random.html">part_random</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">bg_select</span>,</span>
<span>      pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>      method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"kfold"</span>, folds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># If spatial partitioning was successful (contains "best_part_info"), store results and save partition details.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="st">"best_part_info"</span> <span class="op">==</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">part</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Store partitioned presence/pseudo-absence data, adding the species name.</span></span>
<span>    <span class="va">partitioned_psa</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">part</span><span class="op">$</span><span class="va">part</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>species <span class="op">=</span> <span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Save the spatial partition grid (as a raster) for reference or plotting later.</span></span>
<span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span></span>
<span>      <span class="va">part</span><span class="op">$</span><span class="va">grid</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">points_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"_best_part.tif"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      overwrite <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Save partitioning summary (e.g., number of records per fold, SD, etc.).</span></span>
<span>    <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span></span>
<span>      <span class="va">part</span><span class="op">$</span><span class="va">best_part_info</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">points_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"_best_part.txt"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Assign each background point to a partition/fold according to the spatial partitioning.</span></span>
<span>    <span class="va">partitioned_bg</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>      <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/sdm_extract.html">sdm_extract</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">bg_select</span>,</span>
<span>        x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>        y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>        env_layer <span class="op">=</span> <span class="va">part</span><span class="op">$</span><span class="va">grid</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Run garbage collection to free memory before next iteration (useful in large species datasets).</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Combine all species' partitioned presence/pseudo-absence data into a single data frame.</span></span>
<span><span class="va">partitioned_psa</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">partitioned_psa</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine all species' partitioned background data into a single data frame.</span></span>
<span><span class="va">partitioned_bg</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">partitioned_bg</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save the final partitioned datasets to disk for model training and evaluation.</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">partitioned_psa</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">points_dir</span>, <span class="st">"0_partitioned_occurrences_psabsences.txt"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">partitioned_bg</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">points_dir</span>, <span class="st">"0_partitioned_background.txt"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="configuration-of-output-directories-and-data-used-during-model-fitting">11. Configuration of output directories and data used during model
fitting<a class="anchor" aria-label="anchor" href="#configuration-of-output-directories-and-data-used-during-model-fitting"></a>
</h2>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define the directory where model evaluation metrics and performance summaries will be saved.</span></span>
<span><span class="va">dir_perf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">temp_dir</span>, <span class="st">"1_SDM/2_Outputs/0_Model_performance"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define the directory where model predictions for current environmental conditions will be saved.</span></span>
<span><span class="co"># This folder will store the prediction rasters for each algorithm.</span></span>
<span><span class="va">dir_current</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">temp_dir</span>, <span class="st">"1_SDM/2_Outputs/1_Current/Algorithm"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 'dir_fig' is assumed to be previously defined, and will be used for saving figures such as plots and maps.</span></span>
<span><span class="va">dir_fig</span></span>
<span></span>
<span><span class="co"># List all environmental raster files (principal component layers) for each species.</span></span>
<span><span class="co"># These are the PCA-reduced predictor rasters stored in the specified directory.</span></span>
<span><span class="va">sp_pc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">temp_dir</span>, <span class="st">"1_SDM/1_Inputs/4_Predictors_by_sp/1_Current"</span><span class="op">)</span>,</span>
<span>  full.names <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  pattern <span class="op">=</span> <span class="st">".tif"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># List all future environmental raster files (principal component layers) for each species.</span></span>
<span><span class="co"># These are the PCA-reduced predictor rasters stored in the specified directory.</span></span>
<span><span class="va">dir_futur_pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">proj_dir</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">"4_Predictors_by_sp/2_Projection/"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get all species folders (exclude the base folder itself)</span></span>
<span><span class="va">species_dirs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.dirs</a></span><span class="op">(</span><span class="va">dir_futur_pca</span>, recursive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Initialize nested list</span></span>
<span><span class="va">fut_sp_pc_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">sp_dir</span> <span class="kw">in</span> <span class="va">species_dirs</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sp_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">sp_dir</span><span class="op">)</span></span>
<span>  <span class="co"># Get all scenario folders for this species</span></span>
<span>  <span class="va">scenario_dirs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.dirs</a></span><span class="op">(</span><span class="va">sp_dir</span>, recursive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="co"># Initialize list for species</span></span>
<span>  <span class="va">fut_sp_pc_list</span><span class="op">[[</span><span class="va">sp_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">sc_dir</span> <span class="kw">in</span> <span class="va">scenario_dirs</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sc_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">sc_dir</span><span class="op">)</span></span>
<span>    <span class="co"># List all .tif rasters in this scenario folder</span></span>
<span>    <span class="va">tif_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">sc_dir</span>, pattern <span class="op">=</span> <span class="st">"\\.tif$"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="co"># Load all rasters as a raster stack</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tif_files</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">fut_sp_pc_list</span><span class="op">[[</span><span class="va">sp_name</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">sc_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">tif_files</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">fut_sp_pc_list</span><span class="op">[[</span><span class="va">sp_name</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">sc_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Check structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">fut_sp_pc_list</span>, max.level <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign species names to each raster file in 'sp_pc' by stripping the '.tif' extension from the file name.</span></span>
<span><span class="co"># This makes it easy to match species names to their respective PCA raster paths.</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sp_pc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">sp_pc</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".tif"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the partitioned presence and pseudo-absence dataset from file.</span></span>
<span><span class="co"># Each row corresponds to an occurrence or pseudo-absence, along with partition/fold assignments for cross-validation.</span></span>
<span><span class="va">psa</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">proj_dir</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"1_Inputs/1_Occurrences/0_partitioned_occurrences_psabsences.txt"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load the partitioned background points dataset from file.</span></span>
<span><span class="co"># Background points are used in algorithms like Maxent and should also have partition assignments.</span></span>
<span><span class="va">bkgrnd</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_tsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">proj_dir</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"1_Inputs/1_Occurrences/0_partitioned_background.txt"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="main-loop-by-species-for-model-fitting-evaluation-and-prediction">12. Main loop by species for model fitting, evaluation and
prediction<a class="anchor" aria-label="anchor" href="#main-loop-by-species-for-model-fitting-evaluation-and-prediction"></a>
</h2>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get a unique list of species names to iterate through and process each one.</span></span>
<span><span class="va">sp_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">psa</span><span class="op">$</span><span class="va">species</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loop through each species name in the 'sp_names' vector.</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sp_names</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Get the current species name for this iteration.</span></span>
<span>  <span class="va">s_name</span> <span class="op">&lt;-</span> <span class="va">sp_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="co"># Print a message to the console to track progress.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"\n===== Processing species: "</span>, <span class="va">s_name</span>, <span class="st">" ====="</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span>  <span class="co">####      1. Prepare Data for the Current Species       ####</span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span></span>
<span>  <span class="co"># Load the environmental raster data specific to the species.</span></span>
<span>  <span class="va">env_r</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">sp_pc</span><span class="op">[</span><span class="va">s_name</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="co"># Get the names of the environmental variables (predictors).</span></span>
<span>  <span class="va">var_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">env_r</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Filter the presence-absence data for the current species.</span></span>
<span>  <span class="va">sp_pa</span> <span class="op">&lt;-</span> <span class="va">psa</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="va">s_name</span><span class="op">)</span></span>
<span>  <span class="co"># Filter the background data for the current species.</span></span>
<span>  <span class="va">sp_bg</span> <span class="op">&lt;-</span> <span class="va">bkgrnd</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="va">s_name</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Extract environmental data for presence-absence points, removing any points with NA values.</span></span>
<span>  <span class="va">sp_pa</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdm_extract.html">sdm_extract</a></span><span class="op">(</span><span class="va">sp_pa</span>, x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>, env_layer <span class="op">=</span> <span class="va">env_r</span>, filter_na <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="co"># Extract environmental data for background points.</span></span>
<span>  <span class="va">sp_bg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdm_extract.html">sdm_extract</a></span><span class="op">(</span><span class="va">sp_bg</span>, x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>, env_layer <span class="op">=</span> <span class="va">env_r</span>, filter_na <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span>  <span class="co">####                   2. Fit Models                     ####</span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"  &gt; Fitting models..."</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ---- Random Forest (tune_raf) ----</span></span>
<span>  <span class="co"># Tune hyperparameters for a Random Forest model.</span></span>
<span>  <span class="va">m_raf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tune_raf.html">tune_raf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">sp_pa</span>, <span class="co"># Presence-absence data</span></span>
<span>    response <span class="op">=</span> <span class="st">"pr_ab"</span>, <span class="co"># The column with presence/absence (1/0)</span></span>
<span>    predictors <span class="op">=</span> <span class="va">var_names</span>, <span class="co"># Names of environmental variables</span></span>
<span>    partition <span class="op">=</span> <span class="st">".part"</span>, <span class="co"># Column for data partitioning (training/testing)</span></span>
<span>    grid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span> <span class="co"># Define the grid of hyperparameters to test</span></span>
<span>      mtry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">var_names</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>, <span class="co"># Number of variables to sample at each split</span></span>
<span>      ntree <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">400</span>, <span class="fl">600</span>, <span class="fl">800</span>, <span class="fl">1000</span><span class="op">)</span> <span class="co"># Number of trees to grow</span></span>
<span>    <span class="op">)</span>,</span>
<span>    thr <span class="op">=</span> <span class="st">"max_sorensen"</span>, <span class="co"># Threshold to convert continuous prediction to binary</span></span>
<span>    metric <span class="op">=</span> <span class="st">"SORENSEN"</span>, <span class="co"># Metric to evaluate the model performance</span></span>
<span>    n_cores <span class="op">=</span> <span class="fl">4</span> <span class="co"># Number of CPU cores for parallel processing</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ---- Maxent (tune_max) ----</span></span>
<span>  <span class="co"># Tune hyperparameters for a Maxent model.</span></span>
<span>  <span class="va">m_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tune_max.html">tune_max</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">sp_pa</span>,</span>
<span>    response <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>    predictors <span class="op">=</span> <span class="va">var_names</span>,</span>
<span>    background <span class="op">=</span> <span class="va">sp_bg</span>, <span class="co"># Background data is required for Maxent</span></span>
<span>    partition <span class="op">=</span> <span class="st">".part"</span>,</span>
<span>    grid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span> <span class="co"># Define the grid of hyperparameters to test</span></span>
<span>      regmult <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">2</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="co"># Regularization multiplier to prevent overfitting</span></span>
<span>      classes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lq"</span>, <span class="st">"lqh"</span>, <span class="st">"lqhp"</span>, <span class="st">"lqhpt"</span><span class="op">)</span> <span class="co"># Feature classes (l=linear, q=quadratic, etc.)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    thr <span class="op">=</span> <span class="st">"max_sorensen"</span>,</span>
<span>    metric <span class="op">=</span> <span class="st">"SORENSEN"</span>,</span>
<span>    n_cores <span class="op">=</span> <span class="fl">4</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ---- Boosted Regression Tree (tune_gbm) ----</span></span>
<span>  <span class="co"># Tune hyperparameters for a Boosted Regression Tree model.</span></span>
<span>  <span class="va">m_gbm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tune_gbm.html">tune_gbm</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">sp_pa</span>,</span>
<span>    response <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>    predictors <span class="op">=</span> <span class="va">var_names</span>,</span>
<span>    partition <span class="op">=</span> <span class="st">".part"</span>,</span>
<span>    grid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span> <span class="co"># Define the grid of hyperparameters to test</span></span>
<span>      n.trees <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">150</span>, <span class="fl">200</span>, <span class="fl">10</span><span class="op">)</span>, <span class="co"># Number of trees</span></span>
<span>      shrinkage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1.5</span>, <span class="fl">0.2</span><span class="op">)</span>, <span class="co"># Learning rate</span></span>
<span>      n.minobsinnode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">15</span>, <span class="fl">2</span><span class="op">)</span> <span class="co"># Minimum number of observations in a terminal node</span></span>
<span>    <span class="op">)</span>,</span>
<span>    thr <span class="op">=</span> <span class="st">"max_sorensen"</span>,</span>
<span>    metric <span class="op">=</span> <span class="st">"SORENSEN"</span>,</span>
<span>    n_cores <span class="op">=</span> <span class="fl">4</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ---- Generalized Additive Model (fit_gam) ----</span></span>
<span>  <span class="co"># Determine the number of training samples.</span></span>
<span>  <span class="va">n_t</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">:::</span><span class="fu">n_training</span><span class="op">(</span>data <span class="op">=</span> <span class="va">sp_pa</span>, partition <span class="op">=</span> <span class="st">".part"</span><span class="op">)</span></span>
<span>  <span class="co"># Set a starting number for basis functions (k).</span></span>
<span>  <span class="va">candidate_k</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span>  <span class="co"># Reduce 'k' until it's smaller than the number of training samples to avoid errors.</span></span>
<span>  <span class="kw">while</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">n_t</span> <span class="op">&lt;</span> <span class="fu">flexsdm</span><span class="fu">:::</span><span class="fu">n_coefficients</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">sp_pa</span>,</span>
<span>    predictors <span class="op">=</span> <span class="va">var_names</span>,</span>
<span>    k <span class="op">=</span> <span class="va">candidate_k</span></span>
<span>  <span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">candidate_k</span> <span class="op">&lt;-</span> <span class="va">candidate_k</span> <span class="op">-</span> <span class="fl">3</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># Fit a GAM model with the adjusted 'k'.</span></span>
<span>  <span class="va">m_gam</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_gam.html">fit_gam</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">sp_pa</span>,</span>
<span>    response <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>    predictors <span class="op">=</span> <span class="va">var_names</span>,</span>
<span>    partition <span class="op">=</span> <span class="st">".part"</span>,</span>
<span>    thr <span class="op">=</span> <span class="st">"max_sorensen"</span>,</span>
<span>    k <span class="op">=</span> <span class="va">candidate_k</span> <span class="co"># Basis functions parameter</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ---- Generalized Linear Model (fit_glm) ----</span></span>
<span>  <span class="co"># Fit a GLM with a second-degree polynomial term.</span></span>
<span>  <span class="va">m_glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_glm.html">fit_glm</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">sp_pa</span>,</span>
<span>    response <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>    predictors <span class="op">=</span> <span class="va">var_names</span>,</span>
<span>    partition <span class="op">=</span> <span class="st">".part"</span>,</span>
<span>    thr <span class="op">=</span> <span class="st">"max_sorensen"</span>,</span>
<span>    poly <span class="op">=</span> <span class="fl">2</span> <span class="co"># Degree of polynomial functions</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ---- Gaussian Process (fit_gau) ----</span></span>
<span>  <span class="co"># Fit a Gaussian Process model.</span></span>
<span>  <span class="va">m_gau</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_gau.html">fit_gau</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">sp_pa</span>,</span>
<span>    response <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>    predictors <span class="op">=</span> <span class="va">var_names</span>,</span>
<span>    partition <span class="op">=</span> <span class="st">".part"</span>,</span>
<span>    thr <span class="op">=</span> <span class="st">"max_sorensen"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ---- Neural Network (tune_net) ----</span></span>
<span>  <span class="co"># Tune hyperparameters for a Neural Network model.</span></span>
<span>  <span class="va">m_net</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tune_net.html">tune_net</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">sp_pa</span>,</span>
<span>    response <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>    predictors <span class="op">=</span> <span class="va">var_names</span>,</span>
<span>    partition <span class="op">=</span> <span class="st">".part"</span>,</span>
<span>    grid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span> <span class="co"># Define the grid of hyperparameters to test</span></span>
<span>      size <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">var_names</span><span class="op">)</span>, <span class="co"># Number of units in the hidden layer</span></span>
<span>      decay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">1</span>, <span class="fl">0.05</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">6</span><span class="op">)</span> <span class="co"># Weight decay for regularization</span></span>
<span>    <span class="op">)</span>,</span>
<span>    thr <span class="op">=</span> <span class="st">"max_sorensen"</span>,</span>
<span>    metric <span class="op">=</span> <span class="st">"SORENSEN"</span>,</span>
<span>    n_cores <span class="op">=</span> <span class="fl">4</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ---- Support Vector Machine (tune_svm) ----</span></span>
<span>  <span class="co"># Tune hyperparameters for a Support Vector Machine model.</span></span>
<span>  <span class="va">m_svm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tune_svm.html">tune_svm</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">sp_pa</span>,</span>
<span>    response <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>    predictors <span class="op">=</span> <span class="va">var_names</span>,</span>
<span>    partition <span class="op">=</span> <span class="st">".part"</span>,</span>
<span>    grid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>      C <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">60</span>, <span class="fl">5</span><span class="op">)</span>, <span class="co"># Cost parameter for regularization</span></span>
<span>      sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.001</span>, <span class="fl">0.3</span>, <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span> <span class="co"># Kernel parameter</span></span>
<span>    <span class="op">)</span>,</span>
<span>    thr <span class="op">=</span> <span class="st">"max_sorensen"</span>,</span>
<span>    metric <span class="op">=</span> <span class="st">"SORENSEN"</span>,</span>
<span>    n_cores <span class="op">=</span> <span class="fl">4</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Gather all fitted model objects (those starting with "m_") into a single named list.</span></span>
<span>  <span class="va">model_obj_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">mget</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^m_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Clean up the names in the list (e.g., "m_raf" becomes "raf").</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">model_obj_list</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"m_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">model_obj_list</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span>  <span class="co">####    3. Partial Dependence &amp; Variable Importance     ####</span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"  &gt; Calculating PDP and Variable Importance..."</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Initialize an empty list to store variable importance results for each model.</span></span>
<span>  <span class="va">varimp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Loop through each fitted model to generate plots and calculate importance.</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">model_obj_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">mod_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">model_obj_list</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="va">model_obj</span> <span class="op">&lt;-</span> <span class="va">model_obj_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>    <span class="co"># Generate Partial Dependence Plots (PDP) to visualize variable effects.</span></span>
<span>    <span class="co"># The 'p_pdp' function extracts the core model (e.g., randomForest) from the flexsdm object.</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/p_pdp.html">p_pdp</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">model_obj</span><span class="op">$</span><span class="va">model</span>, training_data <span class="op">=</span> <span class="va">sp_pa</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">"-"</span>, <span class="va">mod_name</span><span class="op">)</span><span class="op">)</span> <span class="co"># Add a title to the plot</span></span>
<span></span>
<span>    <span class="co"># If the plot was created successfully, save it as a PNG file.</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span></span>
<span>        plot <span class="op">=</span> <span class="va">p</span>,</span>
<span>        filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_fig</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">"_"</span>, <span class="va">mod_name</span>, <span class="st">"_pdp.png"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        width <span class="op">=</span> <span class="fl">8</span>,</span>
<span>        height <span class="op">=</span> <span class="fl">6</span>,</span>
<span>        dpi <span class="op">=</span> <span class="fl">300</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Calculate variable importance using a permutation-based method.</span></span>
<span>    <span class="va">varimp</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/sdm_varimp.html">sdm_varimp</a></span><span class="op">(</span></span>
<span>      model <span class="op">=</span> <span class="va">model_obj</span>,</span>
<span>      data <span class="op">=</span> <span class="va">sp_pa</span>,</span>
<span>      response <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>      predictors <span class="op">=</span> <span class="va">var_names</span>,</span>
<span>      n_sim <span class="op">=</span> <span class="fl">30</span>, <span class="co"># Number of permutations to run</span></span>
<span>      n_cores <span class="op">=</span> <span class="fl">2</span>,</span>
<span>      thr <span class="op">=</span> <span class="st">"max_sorensen"</span>,</span>
<span>      clamp <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      pred_type <span class="op">=</span> <span class="st">"cloglog"</span> <span class="co"># Use cloglog output for predictions</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Combine the variable importance results from all models into a single data frame.</span></span>
<span>  <span class="va">varimp</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">varimp</span><span class="op">)</span></span>
<span>  <span class="co"># Save the combined variable importance table to a text file.</span></span>
<span>  <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">varimp</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_perf</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">"_varimp.txt"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create a bar plot to visualize variable importance across models.</span></span>
<span>  <span class="va">varimp2</span> <span class="op">&lt;-</span> <span class="va">varimp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>      cols <span class="op">=</span> <span class="va">TPR</span><span class="op">:</span><span class="va">IMAE</span>,</span>
<span>      names_to <span class="op">=</span> <span class="st">"metric"</span>,</span>
<span>      values_to <span class="op">=</span> <span class="st">"value"</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">metric</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AUC"</span>, <span class="st">"TSS"</span>, <span class="st">"SORENSEN"</span><span class="op">)</span><span class="op">)</span> <span class="co"># Filter for specific metrics</span></span>
<span></span>
<span>  <span class="va">p_vi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">varimp2</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">predictors</span>, y <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>, position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">model</span> <span class="op">~</span> <span class="va">metric</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="st">"Predictor variables"</span>,</span>
<span>      y <span class="op">=</span> <span class="st">"Variable importance"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p_vi</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span></span>
<span>    filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_fig</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">"_varImp.png"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    plot <span class="op">=</span> <span class="va">p_vi</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">12</span>, height <span class="op">=</span> <span class="fl">14</span>, dpi <span class="op">=</span> <span class="fl">300</span>, unit <span class="op">=</span> <span class="st">"cm"</span>, scale <span class="op">=</span> <span class="fl">1.5</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Summarize performance metrics (e.g., SORENSEN, TSS) for all individual models.</span></span>
<span>  <span class="va">model_perf</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/sdm_summarize.html">sdm_summarize</a></span><span class="op">(</span><span class="va">model_obj_list</span><span class="op">)</span></span>
<span>  <span class="co"># Save the performance summary to a text file.</span></span>
<span>  <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span><span class="va">model_perf</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_perf</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">"_models_performance.txt"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span>  <span class="co">####        4. Filter Models for Ensemble              ####</span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"  &gt; Filtering models to perform ensemble..."</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Filter models based on performance criteria to select the "best" ones for the ensemble.</span></span>
<span>  <span class="co"># Here, we select models with a mean Sorensen score &gt;= 0.7.</span></span>
<span>  <span class="co"># We also exclude models with thresholds of 0 or 1, as they might indicate overfitting.</span></span>
<span>  <span class="va">good_models_names</span> <span class="op">&lt;-</span> <span class="va">model_perf</span><span class="op">$</span><span class="va">model</span><span class="op">[</span></span>
<span>    <span class="va">model_perf</span><span class="op">$</span><span class="va">SORENSEN_mean</span> <span class="op">&gt;=</span> <span class="fl">0.7</span> <span class="op">&amp;</span></span>
<span>      <span class="va">model_perf</span><span class="op">$</span><span class="va">thr_value</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span></span>
<span>      <span class="va">model_perf</span><span class="op">$</span><span class="va">thr_value</span> <span class="op">&lt;</span> <span class="fl">1</span></span>
<span>  <span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Create a new list containing only the selected "good" models.</span></span>
<span>  <span class="va">good_models</span> <span class="op">&lt;-</span> <span class="va">model_obj_list</span><span class="op">[</span><span class="va">good_models_names</span><span class="op">]</span></span>
<span></span>
<span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span>  <span class="co">####                   5. Ensemble Modeling              ####</span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span>  <span class="co"># Initialize an empty list to store ensemble models.</span></span>
<span>  <span class="va">ensemble_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Only proceed if there is more than one "good" model to create an ensemble.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">good_models</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"  &gt; Fitting model ensemble..."</span><span class="op">)</span></span>
<span>    <span class="co"># Create an ensemble by averaging the predictions of the good models.</span></span>
<span>    <span class="va">m_mean</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/fit_ensemble.html">fit_ensemble</a></span><span class="op">(</span></span>
<span>      <span class="va">good_models</span>,</span>
<span>      ens_method <span class="op">=</span> <span class="st">"mean"</span>, <span class="co"># Ensemble method: mean, weighted_mean, median, etc.</span></span>
<span>      thr_model <span class="op">=</span> <span class="st">"max_sorensen"</span>, <span class="co"># Thresholding method for individual models</span></span>
<span>      thr <span class="op">=</span> <span class="st">"max_sorensen"</span>, <span class="co"># Thresholding method for the final ensemble</span></span>
<span>      metric <span class="op">=</span> <span class="st">"SORENSEN"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Create an ensemble using the median of the predictions.</span></span>
<span>    <span class="va">m_median</span> <span class="op">&lt;-</span></span>
<span>      <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/fit_ensemble.html">fit_ensemble</a></span><span class="op">(</span></span>
<span>        <span class="va">good_models</span>,</span>
<span>        ens_method <span class="op">=</span> <span class="st">"median"</span>,</span>
<span>        thr_model <span class="op">=</span> <span class="st">"max_sorensen"</span>,</span>
<span>        thr <span class="op">=</span> <span class="st">"max_sorensen"</span>,</span>
<span>        metric <span class="op">=</span> <span class="st">"SORENSEN"</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Combine the ensemble models into a list.</span></span>
<span>    <span class="va">ensemble_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">m_mean</span>, median <span class="op">=</span> <span class="va">m_median</span><span class="op">)</span></span>
<span>    <span class="co"># Summarize the performance of the ensemble models.</span></span>
<span>    <span class="va">ens_perf</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/sdm_summarize.html">sdm_summarize</a></span><span class="op">(</span><span class="va">ensemble_list</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Combine the performance tables of individual models and ensemble models.</span></span>
<span>    <span class="va">model_perf_with_ens</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">model_perf</span>, <span class="va">ens_perf</span><span class="op">)</span></span>
<span>    <span class="co"># Overwrite the previous performance file to include the ensemble results.</span></span>
<span>    <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_tsv</a></span><span class="op">(</span></span>
<span>      <span class="va">model_perf_with_ens</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_perf</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">"_models_performance.txt"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span>  <span class="co">####                  6. Spatial Predictions             ####</span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"  &gt; Predicting models ..."</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">good_models</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span>  <span class="co"># Predict habitat suitability for each of the "good" individual models.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">good_models</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">prd_list</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/sdm_predict.html">sdm_predict</a></span><span class="op">(</span></span>
<span>      models <span class="op">=</span> <span class="va">good_models</span>, <span class="co"># List of good models</span></span>
<span>      pred <span class="op">=</span> <span class="va">env_r</span>, <span class="co"># Environmental raster layers to predict onto</span></span>
<span>      thr <span class="op">=</span> <span class="st">"max_sorensen"</span>,</span>
<span>      clamp <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># Restrict predictions to the range of training data</span></span>
<span>      con_thr <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># Produce continuous and binary (thresholded) predictions</span></span>
<span>      pred_type <span class="op">=</span> <span class="st">"cloglog"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Loop through the list of predictions and save each one as a GeoTIFF raster file.</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">alg</span> <span class="kw">in</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">prd_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span></span>
<span>        <span class="va">prd_list</span><span class="op">[[</span><span class="va">alg</span><span class="op">]</span><span class="op">]</span>,</span>
<span>        filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_current</span>, <span class="va">alg</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">".tif"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        filetype <span class="op">=</span> <span class="st">"GTiff"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Predict habitat suitability for the ensemble models.</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ensemble_list</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">ensemble_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">ens_prd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdm_predict.html">sdm_predict</a></span><span class="op">(</span></span>
<span>        models <span class="op">=</span> <span class="va">ensemble_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>        pred <span class="op">=</span> <span class="va">env_r</span>,</span>
<span>        thr <span class="op">=</span> <span class="st">"max_sorensen"</span>,</span>
<span>        con_thr <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        clamp <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        pred_type <span class="op">=</span> <span class="st">"cloglog"</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Save prediction as a GeoTIFF.</span></span>
<span>      <span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span></span>
<span>        <span class="va">ens_prd</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>        filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_current</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ensemble_list</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">".tif"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        filetype <span class="op">=</span> <span class="st">"GTiff"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span>  <span class="co">####               7. Future projections                ####</span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"  &gt; Predicting models for future projections ..."</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">fut_env</span> <span class="op">&lt;-</span> <span class="va">fut_sp_pc_list</span><span class="op">[[</span><span class="va">s_name</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Loop over each scenario raster stack (fut_sp_pc_list already has species-&gt;scenario-&gt;raster)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">sc_name</span> <span class="kw">in</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fut_env</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">env_r</span> <span class="op">&lt;-</span> <span class="va">fut_env</span><span class="op">[[</span><span class="va">sc_name</span><span class="op">]</span><span class="op">]</span> <span class="co"># raster stack for this scenario</span></span>
<span></span>
<span>    <span class="co"># Create output folder if it doesn't exist</span></span>
<span>    <span class="va">dir_future</span> <span class="op">&lt;-</span> <span class="va">proj_dir</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"2_Outputs/2_Projection"</span><span class="op">)</span>, <span class="va">proj_dir</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span>    <span class="co"># --- Predict individual models ---</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">good_models</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">prd_list</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/sdm_predict.html">sdm_predict</a></span><span class="op">(</span></span>
<span>        models <span class="op">=</span> <span class="va">good_models</span>,</span>
<span>        pred <span class="op">=</span> <span class="va">env_r</span>,</span>
<span>        thr <span class="op">=</span> <span class="st">"max_sorensen"</span>,</span>
<span>        clamp <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        con_thr <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        pred_type <span class="op">=</span> <span class="st">"cloglog"</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Save individual model predictions</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">alg</span> <span class="kw">in</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">prd_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span></span>
<span>          <span class="va">prd_list</span><span class="op">[[</span><span class="va">alg</span><span class="op">]</span><span class="op">]</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_future</span>, <span class="va">sc_name</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Algorithm"</span><span class="op">)</span>, <span class="va">alg</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">".tif"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>          filetype <span class="op">=</span> <span class="st">"GTiff"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># --- Predict ensemble models ---</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ensemble_list</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">ensemble_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">ens_prd</span> <span class="op">&lt;-</span> <span class="fu">flexsdm</span><span class="fu">::</span><span class="fu"><a href="../reference/sdm_predict.html">sdm_predict</a></span><span class="op">(</span></span>
<span>          models <span class="op">=</span> <span class="va">ensemble_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>          pred <span class="op">=</span> <span class="va">env_r</span>,</span>
<span>          thr <span class="op">=</span> <span class="st">"max_sorensen"</span>,</span>
<span>          clamp <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>          con_thr <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>          pred_type <span class="op">=</span> <span class="st">"cloglog"</span></span>
<span>        <span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Save ensemble prediction</span></span>
<span>        <span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span></span>
<span>          <span class="va">ens_prd</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>          filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>            <span class="va">dir_future</span>,</span>
<span>            <span class="va">sc_name</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Algorithm"</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ensemble_list</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">".tif"</span><span class="op">)</span></span>
<span>          <span class="op">)</span>,</span>
<span>          overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>          filetype <span class="op">=</span> <span class="st">"GTiff"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span>  <span class="co">####                 8. Clean Up for Next Iteration      ####</span></span>
<span>  <span class="co">## %######################################################%##</span></span>
<span>  <span class="co"># Remove all model objects (starting with "m_") to free up memory.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"^m_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Remove another temporary object if it exists.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"alg_prd_cont"</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">alg_prd_cont</span><span class="op">)</span></span>
<span>  <span class="co"># Trigger garbage collection to release memory explicitly.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="co"># End of the main species loop.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualization-of-spatial-predictions">13. Visualization of spatial predictions<a class="anchor" aria-label="anchor" href="#visualization-of-spatial-predictions"></a>
</h2>
<p>Iterate through each species to process its maps in isolation. This
is more memory efficient than loading everything at once.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">s_name</span> <span class="kw">in</span> <span class="va">sp_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"  - Processing maps for:"</span>, <span class="va">s_name</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># 1. Search recursively for all prediction raster files (.tif) for the current species.</span></span>
<span>  <span class="co">#    Each file represents a prediction from a different model or ensemble.</span></span>
<span>  <span class="co">#    The pattern ensures only files ending with the species name and .tif extension are matched.</span></span>
<span>  <span class="va">species_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span></span>
<span>    path <span class="op">=</span> <span class="va">dir_current</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">".tif$"</span><span class="op">)</span>, <span class="co"># '$' anchors the match to the end of the filename</span></span>
<span>    recursive <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    full.names <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># If no prediction files are found for this species, output a message and skip to the next species.</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">species_files</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"    - No prediction files were found for"</span>, <span class="va">s_name</span>, <span class="st">". Skipping."</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">next</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># 2. Load all prediction raster files and convert them to a format suitable for plotting with ggplot2.</span></span>
<span>  <span class="va">r_cont</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># list to store continuous models</span></span>
<span>  <span class="va">r_semibin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># list to store semi-binary models</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">species_files</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">r_cont</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">species_files</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">r_semibin</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">species_files</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">r_cont</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="va">r_cont</span><span class="op">)</span></span>
<span>  <span class="va">r_semibin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="va">r_semibin</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">r_semibin</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">r_cont</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># 3. Plot the continuous habitat suitability maps for this species, with one facet per model.</span></span>
<span>  <span class="va">p_map_cont</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">tidyterra</span><span class="fu">::</span><span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">r_cont</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">lyr</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_princess.html" class="external-link">scale_fill_princess_c</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"america"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># 4. Plot the semibinary habitat suitability maps for this species, with one facet per model.</span></span>
<span>  <span class="va">p_map_semibin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">tidyterra</span><span class="fu">::</span><span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">r_semibin</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">lyr</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_princess.html" class="external-link">scale_fill_princess_c</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"america"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co"># 5. Save the generated map as a PNG file in the figures directory, one file per species.</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span></span>
<span>    filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_fig</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">"_cont_map"</span>, <span class="st">".png"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    plot <span class="op">=</span> <span class="va">p_map_cont</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">12</span>, height <span class="op">=</span> <span class="fl">10</span>, dpi <span class="op">=</span> <span class="fl">300</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span></span>
<span>    filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_fig</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">"_semibin_map"</span>, <span class="st">".png"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    plot <span class="op">=</span> <span class="va">p_map_semibin</span>,</span>
<span>    width <span class="op">=</span> <span class="fl">12</span>, height <span class="op">=</span> <span class="fl">10</span>, dpi <span class="op">=</span> <span class="fl">300</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">" - Map saved for:"</span>, <span class="va">s_name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"\nCheck figures output in 'dir_fig' path"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"\nScript successfully completed!"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualize-future-projections">14. Visualize future projections<a class="anchor" aria-label="anchor" href="#visualize-future-projections"></a>
</h2>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Base folder with future projections</span></span>
<span><span class="va">dir_future</span> <span class="op">&lt;-</span> <span class="va">proj_dir</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"2_Outputs/2_Projection"</span><span class="op">)</span>, <span class="va">proj_dir</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># List of scenarios (folders)</span></span>
<span><span class="va">scenario_folders</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.dirs</a></span><span class="op">(</span><span class="va">dir_future</span>, recursive <span class="op">=</span> <span class="cn">FALSE</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s_name</span> <span class="kw">in</span> <span class="va">sp_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Processing species: "</span>, <span class="va">s_name</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">sc_folder</span> <span class="kw">in</span> <span class="va">scenario_folders</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sc_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">sc_folder</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># List algorithm folders</span></span>
<span>    <span class="va">alg_folders</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.dirs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">sc_folder</span>, <span class="st">"Algorithm"</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">FALSE</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">r_cont_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">r_semibin_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">alg_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">alg_folder</span> <span class="kw">in</span> <span class="va">alg_folders</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">alg_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">alg_folder</span><span class="op">)</span></span>
<span>      <span class="va">r_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">alg_folder</span>, pattern <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">".tif$"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">r_file</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="kw">next</span></span>
<span></span>
<span>      <span class="va">r_stack</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">r_file</span><span class="op">)</span></span>
<span>      <span class="va">r_cont_list</span><span class="op">[[</span><span class="va">alg_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">r_stack</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="va">r_semibin_list</span><span class="op">[[</span><span class="va">alg_name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">r_stack</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="va">alg_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">alg_names</span>, <span class="va">alg_name</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Skip if no raster files found</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">r_cont_list</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"  - No raster files found for species "</span>, <span class="va">s_name</span>, <span class="st">" in scenario "</span>, <span class="va">sc_name</span>, <span class="st">". Skipping."</span><span class="op">)</span></span>
<span>      <span class="kw">next</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Combine rasters into a single SpatRaster for ggplot faceting</span></span>
<span>    <span class="va">r_cont</span> <span class="op">&lt;-</span> <span class="va">r_cont_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">r_cont_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">r_cont</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">r_cont</span>, <span class="va">r_cont_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">r_semibin</span> <span class="op">&lt;-</span> <span class="va">r_semibin_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">r_semibin_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">r_semibin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">r_semibin</span>, <span class="va">r_semibin_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">r_semibin</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">r_cont</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Continuous map</span></span>
<span>    <span class="va">p_cont</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">tidyterra</span><span class="fu">::</span><span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">r_cont</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">lyr</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_princess.html" class="external-link">scale_fill_princess_c</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"america"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="va">sc_name</span>, <span class="st">"Continuous"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_fig</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">"_"</span>, <span class="va">sc_name</span>, <span class="st">"_cont.png"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      plot <span class="op">=</span> <span class="va">p_cont</span>, width <span class="op">=</span> <span class="fl">12</span>, height <span class="op">=</span> <span class="fl">10</span>, dpi <span class="op">=</span> <span class="fl">300</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Semibinary map</span></span>
<span>    <span class="va">p_semibin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">tidyterra</span><span class="fu">::</span><span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html" class="external-link">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">r_semibin</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">lyr</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_princess.html" class="external-link">scale_fill_princess_c</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"america"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="va">sc_name</span>, <span class="st">"Semibinary"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dir_fig</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s_name</span>, <span class="st">"_"</span>, <span class="va">sc_name</span>, <span class="st">"_semibin.png"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      plot <span class="op">=</span> <span class="va">p_semibin</span>, width <span class="op">=</span> <span class="fl">12</span>, height <span class="op">=</span> <span class="fl">10</span>, dpi <span class="op">=</span> <span class="fl">300</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"  - Faceted maps saved for scenario "</span>, <span class="va">sc_name</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="conclusion">15. Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>In this workflow, we demonstrated a complex, complete species
distribution modeling pipeline using the <code>flexsdm</code>
package.</p>
<p>Here is a step-by-step breakdown of the process:</p>
<div class="section level3">
<h3 id="initial-setup">1. Initial Setup<a class="anchor" aria-label="anchor" href="#initial-setup"></a>
</h3>
<ul>
<li>Installation and loading of required packages</li>
<li>Directory setup</li>
<li>Basic R Markdown parameter configuration</li>
<li>Setting seed for reproducibility</li>
</ul>
</div>
<div class="section level3">
<h3 id="data-preparation">2. Data Preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h3>
<ul>
<li>Loading palm species occurrence data</li>
<li>Transformation of coordinates to spatial objects</li>
<li>Initial visualization of occurrence points (static and
interactive)</li>
</ul>
</div>
<div class="section level3">
<h3 id="environmental-data-1">3. Environmental Data<a class="anchor" aria-label="anchor" href="#environmental-data-1"></a>
</h3>
<ul>
<li>Download of WorldClim bioclimatic variables (current and
future)</li>
<li>Cropping to area of interest (South Brazil)</li>
</ul>
</div>
<div class="section level3">
<h3 id="deine-model-calibration-area">4. Deine model calibration area<a class="anchor" aria-label="anchor" href="#deine-model-calibration-area"></a>
</h3>
<ul>
<li>Defined species-specific model calibration areas</li>
</ul>
</div>
<div class="section level3">
<h3 id="evaluate-species-specific-predictor-collinearity">5. Evaluate species-specific predictor collinearity<a class="anchor" aria-label="anchor" href="#evaluate-species-specific-predictor-collinearity"></a>
</h3>
</div>
<div class="section level3">
<h3 id="correct-predictor-collinearity">6. Correct predictor collinearity<a class="anchor" aria-label="anchor" href="#correct-predictor-collinearity"></a>
</h3>
<ul>
<li>Applied species-specific PCA approach to reduce
multicollinearity</li>
</ul>
</div>
<div class="section level3">
<h3 id="environmental-pca-for-all-species">7. Environmental PCA for all species<a class="anchor" aria-label="anchor" href="#environmental-pca-for-all-species"></a>
</h3>
</div>
<div class="section level3">
<h3 id="occurrence-sample-bias-correciton">8. Occurrence sample bias correciton<a class="anchor" aria-label="anchor" href="#occurrence-sample-bias-correciton"></a>
</h3>
</div>
<div class="section level3">
<h3 id="pseudo-absence-generation">9. Pseudo-absence Generation<a class="anchor" aria-label="anchor" href="#pseudo-absence-generation"></a>
</h3>
<ul>
<li>Creation of training areas for each species</li>
<li>Generation of pseudo-absence points</li>
<li>Combination of presences and pseudo-absences</li>
<li>Visualization of presence and pseudo-absence points</li>
</ul>
</div>
<div class="section level3">
<h3 id="data-partitioning-1">10. Data Partitioning<a class="anchor" aria-label="anchor" href="#data-partitioning-1"></a>
</h3>
<ul>
<li>Division of data into training and testing sets</li>
<li>Use of cross-validation (k-fold)</li>
<li>Extraction of environmental values for all points</li>
</ul>
</div>
<div class="section level3">
<h3 id="configure-and-organize-output-directory">11. Configure and organize output directory<a class="anchor" aria-label="anchor" href="#configure-and-organize-output-directory"></a>
</h3>
</div>
<div class="section level3">
<h3 id="modeling">12. Modeling<a class="anchor" aria-label="anchor" href="#modeling"></a>
</h3>
<ul>
<li>Fitting multiple algorithms:</li>
<li>GLM (Generalized Linear Models)</li>
<li>SVM (Support Vector Machines)</li>
<li>Maxent (Maximum Entropy)</li>
<li>Implementation of two approaches:</li>
<li>Standard models</li>
<li>Ensemble models</li>
<li>Generation of prediction maps for each model</li>
<li>Comparative visualization of results</li>
<li>Overlay of presence points on predictions</li>
<li>Variable importance</li>
<li>Apply models to baseline and future climate projections</li>
</ul>
</div>
<div class="section level3">
<h3 id="visualize-spatial-predictions">13. Visualize spatial predictions<a class="anchor" aria-label="anchor" href="#visualize-spatial-predictions"></a>
</h3>
<ul>
<li>Visualize spatial predictions across different algorithms</li>
</ul>
<p>This workflow represents a complete SDM analysis, from data
preparation to final model evaluation, using the <code>flexsdm</code>
package as the main tool. The process is designed to be reproducible and
allows for robust comparison between different modeling techniques.</p>
<p>The flexibility of <code>flexsdm</code> makes it an excellent choice
for SDM analyses, allowing researchers to implement best practices in
species distribution modeling within a unified framework.</p>
</div>
</div>
<div class="section level2">
<h2 id="other-examples-of-entire-modeling-workflows-with-flexsdm-">16. Other examples of entire modeling workflows with flexsdm.<a class="anchor" aria-label="anchor" href="#other-examples-of-entire-modeling-workflows-with-flexsdm-"></a>
</h2>
<p>If you are interested in learning more about constructing SDM for
different species, types, and amounts of occurrence, we also recommend
exploring the codes of the following papers:</p>
<p>1- Rey Pullido, K.G., &amp; Velazco, S.J.E. (<strong>2025</strong>).
<a href="https://www.sciencedirect.com/science/article/pii/S2530064425000173?via%3Dihub" class="external-link">On
protected areas and other effective area-based conservation measures to
conserve biodiversity. Exploring their contribution to Colombian
snakes</a>. <em>Perspective in Ecology and Conservation</em>, 23(2),
pp.110-120.</p>
<ul>
<li><p>Occurrences record datasets are available <a href="www.doi.org/10.6084/m9.figshare.28344461">here</a></p></li>
<li><p>Codes used to create species distribution models, perform spatial
conservation prioritization, and perform analyses are available <a href="www.doi.org/10.6084/m9.figshare.28746371">here</a>.</p></li>
</ul>
<p>2- Rose, M. B., Elías Velazco, S. J., Regan, H. M., &amp; Franklin,
J. (<strong>2023</strong>). R<a href="https://doi.org/10.1111/geb.13618" class="external-link">arity, geography, and plant
exposure to global change in the California Floristic Province</a>.
<em>Global Ecology and Biogeography</em>, 32(2), 218-232.</p>
<ul>
<li>The datasets and R script used in our analyses relating exposure to
species traits are included with the manuscript as Supporting
Information. Additional scripts used to build species distribution
models, assess the impact of land use change, and calculate exposure are
available in this <a href="https://github.com/mrose048/sp_traits_exposure" class="external-link">GitHub
repository</a>.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Santiago J.E. Velazco, Brooke Rose, André F.A. Andrade, Ignacio Minoli, Janet Franklin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
