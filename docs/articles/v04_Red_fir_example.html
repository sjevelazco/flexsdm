<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>flexsdm: Red Fir example • flexsdm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="flexsdm: Red Fir example">
<meta name="google-site-verification" content="gcou8tqRTwNjZ_Mf1kbFgAzzUcY3OF-JB2sPRPTA56I">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">flexsdm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.8</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html" aria-label="Home"><span class="fa fa-home"></span> Home</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v01_pre_modeling.html">1. Overview of Pre-modeling functions</a></li>
    <li><a class="dropdown-item" href="../articles/v02_modeling.html">2. Overview of Modeling functions</a></li>
    <li><a class="dropdown-item" href="../articles/v03_post_modeling.html">3. Overview of Post-modeling functions</a></li>
    <li><a class="dropdown-item" href="../articles/v04_Red_fir_example.html">4. An example with Red Fir</a></li>
    <li><a class="dropdown-item" href="../articles/v05_Rare_species_example.html">5. Modeling a rare species</a></li>
    <li><a class="dropdown-item" href="../articles/v06_Extrapolation_example.html">6. Tools to explore extrapolation in SDMs</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/pkg_citation.html">Citations</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/pkg_citation.html">Citations</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html"><span class="fa fa-newspaper-o"></span> News</a></li>
<li class="nav-item"><a class="nav-link" href="https://sjevelazco.github.io/flexsdm" aria-label="GitHub">GitHub</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/sjevelazco/flexsdm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>flexsdm: Red Fir example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/sjevelazco/flexsdm/blob/HEAD/vignettes/v04_Red_fir_example.Rmd" class="external-link"><code>vignettes/v04_Red_fir_example.Rmd</code></a></small>
      <div class="d-none name"><code>v04_Red_fir_example.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="example-of-full-modeling-process">Example of full modeling process<a class="anchor" aria-label="anchor" href="#example-of-full-modeling-process"></a>
</h2>
<div class="section level3">
<h3 id="study-species-overview-of-methods">Study species &amp; overview of methods<a class="anchor" aria-label="anchor" href="#study-species-overview-of-methods"></a>
</h3>
<p>Here, we used the <em>flexsdm</em> package to model the current
distribution of California red fir (<em>Abies magnifica</em>). Red fir
is a high-elevation conifer species that’s geographic range extends
through the Sierra Nevada in California, USA, into the southern portion
of the Cascade Range of Oregon. For this species, we used presence data
compiled from several public datasets curated by natural resources
agencies. We built the distribution models using four hydro-climatic
variables: actual evapotranspiration, climatic water deficit, maximum
temperature of the warmest month, and minimum temperature of the coldest
month. All variables were resampled (aggregated) to a 1890 m spatial
resolution to improve processing time.</p>
</div>
<div class="section level3">
<h3 id="delimit-of-a-calibration-area">Delimit of a calibration area<a class="anchor" aria-label="anchor" href="#delimit-of-a-calibration-area"></a>
</h3>
<p>Delimiting the calibration area (aka accessible area) is an essential
step in SDMs both in methodological and theoretical terms. The
calibration area will affect several characteristics of a SDM like the
range of environmental variables, the number of absences, the
distribution of background points and pseudo-absences, and
unfortunately, some performance metrics like AUC and TSS. There are
several ways to delimit a calibration area. In <a href="https://sjevelazco.github.io/flexsdm/reference/calib_area.html">calib_area()</a>.
We used a method that the calibration area is delimited by a 100-km
buffer around presences (shown in the figure below).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github('sjevelazco/flexsdm')</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sjevelazco.github.io/flexsdm">flexsdm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">somevar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"external/somevar.tif"</span>, package <span class="op">=</span> <span class="st">"flexsdm"</span><span class="op">)</span></span>
<span><span class="va">somevar</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">somevar</span><span class="op">)</span> <span class="co"># environmental data</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">somevar</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"aet"</span>, <span class="st">"cwd"</span>, <span class="st">"tmx"</span>, <span class="st">"tmn"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">abies</span><span class="op">)</span></span>
<span><span class="va">abies_p</span> <span class="op">&lt;-</span> <span class="va">abies</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">pr_ab</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">pr_ab</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># filter only for presence locations</span></span>
<span></span>
<span><span class="va">ca</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/calib_area.html">calib_area</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">abies_p</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"buffer"</span>, width <span class="op">=</span> <span class="fl">100000</span><span class="op">)</span>,</span>
<span>    crs <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">somevar</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="co"># create a calibration area with 100 km buffer around occurrence points</span></span>
<span></span>
<span><span class="co"># visualize the species occurrences</span></span>
<span><span class="va">layer1</span> <span class="op">&lt;-</span> <span class="va">somevar</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">layer1</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">layer1</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">layer1</span>, col <span class="op">=</span> <span class="st">"gray80"</span>, legend <span class="op">=</span> <span class="cn">FALSE</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">ca</span>, <span class="va">layer1</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">abies_p</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"#00000480"</span><span class="op">)</span></span></code></pre></div>
<p><img src="v04_Red_fir_example_files/figure-html/raw%20data-1.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="occurrence-filtering">Occurrence filtering<a class="anchor" aria-label="anchor" href="#occurrence-filtering"></a>
</h3>
<p>Sample bias in species occurrence data has long been a recognized
issue in SDM. However, environmental filtering of observation data can
improve model predictions by reducing redundancy in environmental
(e.g. climatic) hyper-space (Varela et al. 2014). Here we will use the
function occfilt_env() to thin the red fir occurrences based on
environmental space. This function is unique to <em>flexsdm</em>, and in
contrast with other packages is able to use any number of environmental
dimensions and does not perform a PCA before filtering.</p>
<p>Next we apply environmental occurrence filtering using 8 bins and
display the resulting filtered occurrence data</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">abies_p</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">abies_p</span><span class="op">)</span> <span class="co"># adding unique id to each row</span></span>
<span><span class="va">abies_pf</span> <span class="op">&lt;-</span> <span class="va">abies_p</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/occfilt_env.html">occfilt_env</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">.</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>    nbins <span class="op">=</span> <span class="fl">8</span>,</span>
<span>    env_layer <span class="op">=</span> <span class="va">somevar</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">abies_p</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Extracting values from raster ...</span></span>
<span><span class="co">#&gt; 27 records were removed because they have NAs for some variables</span></span>
<span><span class="co">#&gt; Number of unfiltered records: 673</span></span>
<span><span class="co">#&gt; Number of filtered records: 216</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">layer1</span>, col <span class="op">=</span> <span class="st">"gray80"</span>, legend <span class="op">=</span> <span class="cn">FALSE</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">ca</span>, <span class="va">layer1</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">abies_p</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"#00000480"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">abies_pf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"#5DC86180"</span><span class="op">)</span></span></code></pre></div>
<p><img src="v04_Red_fir_example_files/figure-html/occurrence%20filtering-1.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="block-partition-with-4-folds">Block partition with 4 folds<a class="anchor" aria-label="anchor" href="#block-partition-with-4-folds"></a>
</h3>
<p>Data partitioning, or splitting data into testing and training
groups, is a key step in building SDMs. <em>flexsdm</em> offers multiple
options for data partitioning and here we use a spatial block method.
Geographically structured data partitioning methods are especially
useful if users want to evaluate model transferability to different
regions or time periods. The part_sblock() function explores spatial
blocks with different raster cells sizes and returns the one that is
best suited for the input datset based on spatial autocorrelation,
environmental similarity, and the number of presence/absence records in
each block partition. The function’s output provides users with 1) a
tibble with presence/absence locations and the assigned partition
number, 2) a tibble with information about the best partition, and 3) a
SpatRaster showing the selected grid. Here we want to divide the data
into 4 different partitions using the spatial block method.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">occ_part</span> <span class="op">&lt;-</span> <span class="va">abies_pf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/part_sblock.html">part_sblock</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">.</span>,</span>
<span>    env_layer <span class="op">=</span> <span class="va">somevar</span>,</span>
<span>    pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    n_part <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    min_res_mult <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    max_res_mult <span class="op">=</span> <span class="fl">200</span>,</span>
<span>    num_grids <span class="op">=</span> <span class="fl">30</span>,</span>
<span>    prop <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; The following grid cell sizes will be tested:</span></span>
<span><span class="co">#&gt; 5670 | 18508.97 | 31347.93 | 44186.9 | 57025.86 | 69864.83 | 82703.79 | 95542.76 | 108381.72 | 121220.69 | 134059.66 | 146898.62 | 159737.59 | 172576.55 | 185415.52 | 198254.48 | 211093.45 | 223932.41 | 236771.38 | 249610.34 | 262449.31 | 275288.28 | 288127.24 | 300966.21 | 313805.17 | 326644.14 | 339483.1 | 352322.07 | 365161.03 | 378000</span></span>
<span><span class="co">#&gt; Creating basic raster mask...</span></span>
<span><span class="co">#&gt; Searching for the optimal grid size...</span></span>
<span><span class="va">abies_pf</span> <span class="op">&lt;-</span> <span class="va">occ_part</span><span class="op">$</span><span class="va">part</span></span>
<span></span>
<span><span class="co"># Transform best block partition to a raster layer with same resolution and extent than</span></span>
<span><span class="co"># predictor variables</span></span>
<span><span class="va">block_layer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_block.html">get_block</a></span><span class="op">(</span>env_layer <span class="op">=</span> <span class="va">somevar</span>, best_grid <span class="op">=</span> <span class="va">occ_part</span><span class="op">$</span><span class="va">grid</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#64146D"</span>, <span class="st">"#9E2962"</span>, <span class="st">"#F47C15"</span>, <span class="st">"#FCFFA4"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">block_layer</span>, col <span class="op">=</span> <span class="va">cl</span>, legend <span class="op">=</span> <span class="cn">FALSE</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">abies_pf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="v04_Red_fir_example_files/figure-html/block%20partition-1.png" width="576"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co"># Number of presences per block</span></span>
<span><span class="va">abies_pf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.part</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 2</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   .part [4]</span></span></span>
<span><span class="co">#&gt;   .part     n</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1    38</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2    59</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     3    33</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     4    86</span></span>
<span><span class="co"># Additional information of the best block</span></span>
<span><span class="va">occ_part</span><span class="op">$</span><span class="va">best_part_info</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 5</span></span></span>
<span><span class="co">#&gt;   n_grid cell_size spa_auto env_sim  sd_p</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     14   <span style="text-decoration: underline;">172</span>577.      0.5    173.  24.1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="pseudo-absencebackground-points-using-partition-previously-created-as-a-mask">Pseudo-absence/background points (using partition previously created
as a mask)<a class="anchor" aria-label="anchor" href="#pseudo-absencebackground-points-using-partition-previously-created-as-a-mask"></a>
</h3>
<p>In this example, we only have species presence data. However, most
SDM methods require either pseudo-absence or background data. Here, we
will use the spatial block partition we just created to generate
pseudo-absence and background points.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Spatial blocks where species occurs</span></span>
<span><span class="co"># Sample background points throughout study area with random method, allocating 10X the number of presences a background</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">bg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/sample_background.html">sample_background</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">abies_pf</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">abies_pf</span><span class="op">$</span><span class="va">.part</span> <span class="op">==</span> <span class="va">x</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"random"</span>,</span>
<span>    rlayer <span class="op">=</span> <span class="va">block_layer</span>,</span>
<span>    maskval <span class="op">=</span> <span class="va">x</span>,</span>
<span>    calibarea <span class="op">=</span> <span class="va">ca</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">bg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdm_extract.html">sdm_extract</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">bg</span>, x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>, env_layer <span class="op">=</span> <span class="va">block_layer</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sample a number of pseudo-absences equal to the presence in each partition</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">psa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/sample_pseudoabs.html">sample_pseudoabs</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">abies_pf</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">abies_pf</span><span class="op">$</span><span class="va">.part</span> <span class="op">==</span> <span class="va">x</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"random"</span>,</span>
<span>    rlayer <span class="op">=</span> <span class="va">block_layer</span>,</span>
<span>    maskval <span class="op">=</span> <span class="va">x</span>,</span>
<span>    calibarea <span class="op">=</span> <span class="va">ca</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">psa</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdm_extract.html">sdm_extract</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">psa</span>, x <span class="op">=</span> <span class="st">"x"</span>, y <span class="op">=</span> <span class="st">"y"</span>, env_layer <span class="op">=</span> <span class="va">block_layer</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#280B50"</span>, <span class="st">"#9E2962"</span>, <span class="st">"#F47C15"</span>, <span class="st">"#FCFFA4"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">block_layer</span>, col <span class="op">=</span> <span class="st">"gray80"</span>, legend <span class="op">=</span> <span class="cn">FALSE</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">bg</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span>, col <span class="op">=</span> <span class="va">cl</span><span class="op">[</span><span class="va">bg</span><span class="op">$</span><span class="va">.part</span><span class="op">]</span>, cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="co"># Background points</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="va">psa</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span>, bg <span class="op">=</span> <span class="va">cl</span><span class="op">[</span><span class="va">psa</span><span class="op">$</span><span class="va">.part</span><span class="op">]</span>, cex <span class="op">=</span> <span class="fl">0.8</span>, pch <span class="op">=</span> <span class="fl">21</span><span class="op">)</span> <span class="co"># Pseudo-absences</span></span></code></pre></div>
<p><img src="v04_Red_fir_example_files/figure-html/pseudo/absence%20and%20background%20data-1.png" width="576"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Bind a presences and pseudo-absences</span></span>
<span><span class="va">abies_pa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">abies_pf</span>, <span class="va">psa</span><span class="op">)</span></span>
<span><span class="va">abies_pa</span> <span class="co"># Presence-Pseudo-absence database</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 432 × 4</span></span></span>
<span><span class="co">#&gt;          x        y pr_ab .part</span></span>
<span><span class="co">#&gt;      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> -<span style="color: #BB0000; text-decoration: underline;">12</span><span style="color: #BB0000;">558.</span>   <span style="text-decoration: underline;">68</span>530.     1     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> <span style="text-decoration: underline;">115</span>217. -<span style="color: #BB0000; text-decoration: underline;">145</span><span style="color: #BB0000;">937.</span>     1     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>   <span style="text-decoration: underline;">3</span>634.   <span style="text-decoration: underline;">22</span>501.     1     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  <span style="text-decoration: underline;">44</span>972.  -<span style="color: #BB0000; text-decoration: underline;">60</span><span style="color: #BB0000;">781.</span>     1     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> -<span style="color: #BB0000; text-decoration: underline;">34</span><span style="color: #BB0000;">463.</span>  <span style="text-decoration: underline;">160</span>313.     1     3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  <span style="text-decoration: underline;">83</span>108.  -<span style="color: #BB0000; text-decoration: underline;">27</span><span style="color: #BB0000;">300.</span>     1     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> <span style="text-decoration: underline;">124</span>877. -<span style="color: #BB0000; text-decoration: underline;">176</span><span style="color: #BB0000;">319.</span>     1     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> <span style="text-decoration: underline;">118</span>707. -<span style="color: #BB0000; text-decoration: underline;">179</span><span style="color: #BB0000;">991.</span>     1     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> <span style="text-decoration: underline;">126</span>141. -<span style="color: #BB0000; text-decoration: underline;">176</span><span style="color: #BB0000;">302.</span>     1     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> -<span style="color: #BB0000; text-decoration: underline;">49</span><span style="color: #BB0000;">722.</span>  <span style="text-decoration: underline;">141</span>124.     1     3</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 422 more rows</span></span></span>
<span><span class="va">bg</span> <span class="co"># Background points</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2,160 × 4</span></span></span>
<span><span class="co">#&gt;           x       y pr_ab .part</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> -<span style="color: #BB0000; text-decoration: underline;">153</span><span style="color: #BB0000;">501.</span> <span style="text-decoration: underline;">392</span>162.     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  -<span style="color: #BB0000; text-decoration: underline;">89</span><span style="color: #BB0000;">241.</span> <span style="text-decoration: underline;">263</span>642.     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  -<span style="color: #BB0000; text-decoration: underline;">89</span><span style="color: #BB0000;">241.</span>  <span style="text-decoration: underline;">27</span>392.     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> -<span style="color: #BB0000; text-decoration: underline;">130</span><span style="color: #BB0000;">821.</span> <span style="text-decoration: underline;">331</span>682.     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> -<span style="color: #BB0000; text-decoration: underline;">132</span><span style="color: #BB0000;">711.</span> <span style="text-decoration: underline;">339</span>242.     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  -<span style="color: #BB0000; text-decoration: underline;">51</span><span style="color: #BB0000;">441.</span> -<span style="color: #BB0000; text-decoration: underline;">63</span><span style="color: #BB0000;">328.</span>     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  -<span style="color: #BB0000; text-decoration: underline;">59</span><span style="color: #BB0000;">001.</span>  <span style="text-decoration: underline;">67</span>082.     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  -<span style="color: #BB0000; text-decoration: underline;">32</span><span style="color: #BB0000;">541.</span> -<span style="color: #BB0000; text-decoration: underline;">51</span><span style="color: #BB0000;">988.</span>     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  -<span style="color: #BB0000; text-decoration: underline;">96</span><span style="color: #BB0000;">801.</span>    932.     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  -<span style="color: #BB0000; text-decoration: underline;">47</span><span style="color: #BB0000;">661.</span> -<span style="color: #BB0000; text-decoration: underline;">31</span><span style="color: #BB0000;">198.</span>     0     1</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2,150 more rows</span></span></span></code></pre></div>
<p>Extract environmental data for the presence-absence and background
data . View the distributions of present points, pseudo-absence points,
and background points using the blocks as a reference map.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">abies_pa</span> <span class="op">&lt;-</span> <span class="va">abies_pa</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/sdm_extract.html">sdm_extract</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">.</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    env_layer <span class="op">=</span> <span class="va">somevar</span>,</span>
<span>    filter_na <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">bg</span> <span class="op">&lt;-</span> <span class="va">bg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/sdm_extract.html">sdm_extract</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">.</span>,</span>
<span>    x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>    env_layer <span class="op">=</span> <span class="va">somevar</span>,</span>
<span>    filter_na <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fit-models-with-tune_max-fit_gau-and-fit_glm">Fit models with tune_max, fit_gau, and fit_glm<a class="anchor" aria-label="anchor" href="#fit-models-with-tune_max-fit_gau-and-fit_glm"></a>
</h3>
<p>Now, fit our models. The <em>flexsdm</em> package offers a wide range
of modeling options, from traditional statistical methods like GLMs and
GAMs, to machine learning methods like random forests and support vector
machines. For each modeling method, <em>flexsdm</em> provides both fit_
and tune_ functions, which allow users to use default settings or adjust
hyperparameters depending on their research goals. Here, we will test
out tune_max() (tuned Maximum Entropy model), fit_gau() (fit Guassian
Process model), and fit_glm (fit Generalized Linear Model). For each
model, we selected three threshold values to generate binary suitability
predictions: the threshold that maximizes TSS (max_sens_spec), the
threshold at which sensitivity and specificity are equal
(equal_sens_spec), and the threshold at which the Sorenson index is
highest (max_sorenson). In this example, we selected TSS as the
performance metric used for selecting the best combination of
hyper-parameter values in the tuned Maximum Entropy model.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tune_max.html">tune_max</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">abies_pa</span>,</span>
<span>  response <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>  predictors <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">somevar</span><span class="op">)</span>,</span>
<span>  background <span class="op">=</span> <span class="va">bg</span>,</span>
<span>  partition <span class="op">=</span> <span class="st">".part"</span>,</span>
<span>  grid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>    regmult <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">3</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    classes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="st">"lq"</span>, <span class="st">"lqhpt"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  thr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"max_sens_spec"</span>, <span class="st">"equal_sens_spec"</span>, <span class="st">"max_sorensen"</span><span class="op">)</span>,</span>
<span>  metric <span class="op">=</span> <span class="st">"TSS"</span>,</span>
<span>  clamp <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  pred_type <span class="op">=</span> <span class="st">"cloglog"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Tuning model...</span></span>
<span><span class="co">#&gt; Replica number: 1/1</span></span>
<span><span class="co">#&gt; Partition number: 1/4</span></span>
<span><span class="co">#&gt; Partition number: 2/4</span></span>
<span><span class="co">#&gt; Partition number: 3/4</span></span>
<span><span class="co">#&gt; Partition number: 4/4</span></span>
<span><span class="co">#&gt; Fitting best model</span></span>
<span><span class="co">#&gt; Formula used for model fitting:</span></span>
<span><span class="co">#&gt; ~aet + cwd + tmx + tmn + I(aet^2) + I(cwd^2) + I(tmx^2) + I(tmn^2) + hinge(aet) + hinge(cwd) + hinge(tmx) + hinge(tmn) + thresholds(aet) + thresholds(cwd) + thresholds(tmx) + thresholds(tmn) + cwd:aet + tmx:aet + tmn:aet + tmx:cwd + tmn:cwd + tmn:tmx - 1</span></span>
<span><span class="co">#&gt; Replica number: 1/1</span></span>
<span><span class="co">#&gt; Partition number: 1/4</span></span>
<span><span class="co">#&gt; Partition number: 2/4</span></span>
<span><span class="co">#&gt; Partition number: 3/4</span></span>
<span><span class="co">#&gt; Partition number: 4/4</span></span>
<span><span class="va">f_gau</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_gau.html">fit_gau</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">abies_pa</span>,</span>
<span>  response <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>  predictors <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">somevar</span><span class="op">)</span>,</span>
<span>  partition <span class="op">=</span> <span class="st">".part"</span>,</span>
<span>  thr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"max_sens_spec"</span>, <span class="st">"equal_sens_spec"</span>, <span class="st">"max_sorensen"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Replica number: 1/1</span></span>
<span><span class="co">#&gt; Partition number: 1/4</span></span>
<span><span class="co">#&gt; Partition number: 2/4</span></span>
<span><span class="co">#&gt; Partition number: 3/4</span></span>
<span><span class="co">#&gt; Partition number: 4/4</span></span>
<span><span class="va">f_glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_glm.html">fit_glm</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">abies_pa</span>,</span>
<span>  response <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>  predictors <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">somevar</span><span class="op">)</span>,</span>
<span>  partition <span class="op">=</span> <span class="st">".part"</span>,</span>
<span>  thr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"max_sens_spec"</span>, <span class="st">"equal_sens_spec"</span>, <span class="st">"max_sorensen"</span><span class="op">)</span>,</span>
<span>  poly <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Formula used for model fitting:</span></span>
<span><span class="co">#&gt; pr_ab ~ aet + cwd + tmx + tmn + I(aet^2) + I(cwd^2) + I(tmx^2) + I(tmn^2)</span></span>
<span><span class="co">#&gt; Replica number: 1/1</span></span>
<span><span class="co">#&gt; Partition number: 1/4</span></span>
<span><span class="co">#&gt; Partition number: 2/4</span></span>
<span><span class="co">#&gt; Partition number: 3/4</span></span>
<span><span class="co">#&gt; Partition number: 4/4</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fit-an-ensemble-model">Fit an ensemble model<a class="anchor" aria-label="anchor" href="#fit-an-ensemble-model"></a>
</h3>
<p>Spatial predictions from different SDM algorithms can vary
substantially, and ensemble modeling has become increasingly popular.
With the fit_ensemble() function, users can easily produce an ensemble
SDM based on any of the individual fit_ and tune_ models included the
package. In this example, we fit an ensemble model for red fir based on
the weighted average of the three individual models. We used the same
threshold values and performance metric that were implemented in the
individual models.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ens_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_ensemble.html">fit_ensemble</a></span><span class="op">(</span></span>
<span>  models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">t_max</span>, <span class="va">f_gau</span>, <span class="va">f_glm</span><span class="op">)</span>,</span>
<span>  ens_method <span class="op">=</span> <span class="st">"meanw"</span>,</span>
<span>  thr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"max_sens_spec"</span>, <span class="st">"equal_sens_spec"</span>, <span class="st">"max_sorensen"</span><span class="op">)</span>,</span>
<span>  thr_model <span class="op">=</span> <span class="st">"max_sens_spec"</span>,</span>
<span>  metric <span class="op">=</span> <span class="st">"TSS"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;   |                                                                              |                                                                      |   0%  |                                                                              |======================================================================| 100%</span></span>
<span><span class="va">ens_m</span><span class="op">$</span><span class="va">performance</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 25</span></span></span>
<span><span class="co">#&gt;   model threshold      thr_value n_presences n_absences TPR_mean TPR_sd TNR_mean</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> meanw equal_sens_sp…     0.582         216        216    0.787 0.079<span style="text-decoration: underline;">5</span>    0.808</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> meanw max_sens_spec      0.470         216        216    0.949 0.016<span style="text-decoration: underline;">2</span>    0.752</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> meanw max_sorensen       0.449         216        216    0.963 0.014<span style="text-decoration: underline;">3</span>    0.738</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 17 more variables: TNR_sd &lt;dbl&gt;, SORENSEN_mean &lt;dbl&gt;, SORENSEN_sd &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   JACCARD_mean &lt;dbl&gt;, JACCARD_sd &lt;dbl&gt;, FPB_mean &lt;dbl&gt;, FPB_sd &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   OR_mean &lt;dbl&gt;, OR_sd &lt;dbl&gt;, TSS_mean &lt;dbl&gt;, TSS_sd &lt;dbl&gt;, AUC_mean &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   AUC_sd &lt;dbl&gt;, BOYCE_mean &lt;dbl&gt;, BOYCE_sd &lt;dbl&gt;, IMAE_mean &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   IMAE_sd &lt;dbl&gt;</span></span></span></code></pre></div>
<p>The output of <em>flexsdm</em> model objects allows you to easily
compare metrics across models, such as AUC or TSS. For example, we can
use the sdm_summarize() function to merge model performance tables.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_perf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdm_summarize.html">sdm_summarize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">t_max</span>, <span class="va">f_gau</span>, <span class="va">f_glm</span>, <span class="va">ens_m</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">model_perf</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 28</span></span></span>
<span><span class="co">#&gt;    model_ID model threshold     thr_value n_presences n_absences TPR_mean TPR_sd</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>        1 max   max_sens_spec     0.364         216        216    0.954 0.031<span style="text-decoration: underline;">6</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>        2 gau   equal_sens_s…     0.643         216        216    0.784 0.089<span style="text-decoration: underline;">0</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>        2 gau   max_sens_spec     0.471         216        216    0.952 0.012<span style="text-decoration: underline;">2</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>        2 gau   max_sorensen      0.471         216        216    0.964 0.010<span style="text-decoration: underline;">8</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>        3 glm   equal_sens_s…     0.649         216        216    0.800 0.085<span style="text-decoration: underline;">1</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>        3 glm   max_sens_spec     0.554         216        216    0.954 0.049<span style="text-decoration: underline;">3</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>        3 glm   max_sorensen      0.423         216        216    0.977 0.037<span style="text-decoration: underline;">9</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>        4 meanw equal_sens_s…     0.582         216        216    0.787 0.079<span style="text-decoration: underline;">5</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>        4 meanw max_sens_spec     0.470         216        216    0.949 0.016<span style="text-decoration: underline;">2</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>        4 meanw max_sorensen      0.449         216        216    0.963 0.014<span style="text-decoration: underline;">3</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 20 more variables: TNR_mean &lt;dbl&gt;, TNR_sd &lt;dbl&gt;, SORENSEN_mean &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   SORENSEN_sd &lt;dbl&gt;, JACCARD_mean &lt;dbl&gt;, JACCARD_sd &lt;dbl&gt;, FPB_mean &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   FPB_sd &lt;dbl&gt;, OR_mean &lt;dbl&gt;, OR_sd &lt;dbl&gt;, TSS_mean &lt;dbl&gt;, TSS_sd &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   AUC_mean &lt;dbl&gt;, AUC_sd &lt;dbl&gt;, BOYCE_mean &lt;dbl&gt;, BOYCE_sd &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   IMAE_mean &lt;dbl&gt;, IMAE_sd &lt;dbl&gt;, regmult &lt;dbl&gt;, classes &lt;fct&gt;</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="project-the-ensemble-model">Project the ensemble model<a class="anchor" aria-label="anchor" href="#project-the-ensemble-model"></a>
</h3>
<p>Next we project the ensemble model in space across the entire extent
of our environmental layer, the California Floristic Province, using the
sdm_predict() function. This function can be use to predict species
suitability across any area for species’ current or future suitability.
In this example, we only project the ensemble model with one threshold,
though users have the option to project multiple models with multiple
threshold values. Here, we also specify that we want the function to
return a SpatRast with continuous suitability values above the threshold
(con_thr = TRUE).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pr_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sdm_predict.html">sdm_predict</a></span><span class="op">(</span></span>
<span>  models <span class="op">=</span> <span class="va">ens_m</span>,</span>
<span>  pred <span class="op">=</span> <span class="va">somevar</span>,</span>
<span>  thr <span class="op">=</span> <span class="st">"max_sens_spec"</span>,</span>
<span>  con_thr <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  predict_area <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Predicting ensembles</span></span>
<span></span>
<span><span class="va">unconstrained</span> <span class="op">&lt;-</span> <span class="va">pr_1</span><span class="op">$</span><span class="va">meanw</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">unconstrained</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"unconstrained"</span></span>
<span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#FDE725"</span>, <span class="st">"#B3DC2B"</span>, <span class="st">"#6DCC57"</span>, <span class="st">"#36B677"</span>, <span class="st">"#1F9D87"</span>, <span class="st">"#25818E"</span>, <span class="st">"#30678D"</span>, <span class="st">"#3D4988"</span>, <span class="st">"#462777"</span>, <span class="st">"#440154"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">unconstrained</span>, col <span class="op">=</span> <span class="va">cl</span>, legend <span class="op">=</span> <span class="cn">FALSE</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="v04_Red_fir_example_files/figure-html/predict%20models-1.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="constrain-the-model-with-msdm_posterior">Constrain the model with msdm_posterior<a class="anchor" aria-label="anchor" href="#constrain-the-model-with-msdm_posterior"></a>
</h3>
<p>Finally, <em>flexsdm</em> offers users function that help correct
overprediction of SDM based on occurrence records and suitability
patterns. In this example we constrained the ensemble model using the
method “occurrence based restriction”, which assumes that suitable
patches that intercept species occurrences are more likely a part of
species distributions than suitable patches that do not intercept any
occurrences. Because all methods of the msdm_posteriori() function work
with presences it is important to always use the original database
(i.e., presences that have not been spatially or environmentally
filtered). All of the methods available in the msdm_posteriori()
function are based on Mendes et al. (2020).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thr_val</span> <span class="op">&lt;-</span> <span class="va">ens_m</span><span class="op">$</span><span class="va">performance</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">threshold</span> <span class="op">==</span> <span class="st">"max_sens_spec"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">thr_value</span><span class="op">)</span></span>
<span><span class="va">m_pres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/msdm_posteriori.html">msdm_posteriori</a></span><span class="op">(</span></span>
<span>  records <span class="op">=</span> <span class="va">abies_p</span>,</span>
<span>  x <span class="op">=</span> <span class="st">"x"</span>,</span>
<span>  y <span class="op">=</span> <span class="st">"y"</span>,</span>
<span>  pr_ab <span class="op">=</span> <span class="st">"pr_ab"</span>,</span>
<span>  cont_suit <span class="op">=</span> <span class="va">pr_1</span><span class="op">$</span><span class="va">meanw</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"obr"</span><span class="op">)</span>,</span>
<span>  thr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sensitivity"</span>, sens <span class="op">=</span> <span class="va">thr_val</span><span class="op">)</span>,</span>
<span>  buffer <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">constrained</span> <span class="op">&lt;-</span> <span class="va">m_pres</span><span class="op">$</span><span class="va">meanw</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">constrained</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"constrained"</span></span>
<span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#FDE725"</span>, <span class="st">"#B3DC2B"</span>, <span class="st">"#6DCC57"</span>, <span class="st">"#36B677"</span>, <span class="st">"#1F9D87"</span>, <span class="st">"#25818E"</span>, <span class="st">"#30678D"</span>, <span class="st">"#3D4988"</span>, <span class="st">"#462777"</span>, <span class="st">"#440154"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">constrained</span>, col <span class="op">=</span> <span class="va">cl</span>, legend <span class="op">=</span> <span class="cn">FALSE</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="v04_Red_fir_example_files/figure-html/constrain%20with%20msdm-1.png" width="576">
#=========#=========#=========#=========#=========#=========#=========#</p>
<p><strong>Vignette still under construction and changes</strong></p>
<p>#=========#=========#=========#=========#=========#=========#=========#</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Santiago J.E. Velazco, Brooke Rose, André F.A. Andrade, Ignacio Minoli, Janet Franklin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
